	MODULE INTEGRATION

	USE GSQUAD
	USE NURBS_BASIS
	USE LOADFUNCTION

	implicit integer (i-n)
	implicit real(8) (a-h,o-z)

CONTAINS


!------------------INTEGRAL CODE FOR THE STIFFNESS MATRIX ELEMENT--------------
SUBROUTINE GEN_KF(STIF_K, STIF_F)

	REAL*8, INTENT(OUT) :: STIF_K(2*DOF, 2*DOF), STIF_F(2*DOF)
	TYPE(RECPATCH) :: IRBOX
	TYPE(POINT2D) :: GSPT, DMY_GSPT, LOAD_F(NUMGSPT**2)
	TYPE(INT2D), ALLOCATABLE :: INDX1(:), INDX2(:)
	TYPE(MATRIX_22) :: JACOB
	TYPE(FVALUE), ALLOCATABLE :: SF1(:,:), SF2(:,:)
	INTEGER :: I,J, K, II, JJ, KK, N, GLOBAL_INDX(6), PATCH, IGA_PATCH, EGM_PATCH
	REAL*8 :: DIFF_XX, DIFF_YY, DIFF_XY, DIFF_YX, DIFF_NN, SUB_LN_LENGTH(2)
	
	INTEGER :: EGM_I, EGM_J, IGA_I, IGA_J
	TYPE(POINT2D) :: LOWER_LIMIT, UPPER_LIMIT
	TYPE(FUNCTION_2D) :: TSBS
	
	STIF_K(:,:) = 0.D0; STIF_F(:) = 0.D0

	!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! IGA - IGA / EGM - EGM !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
	!! Compute an element on IGA - IGA or EGM - EGM
	ALLOCATE(WEIGHT(NUMGSPT**2))
	DO PATCH = 1, NUM_PATCH
		ALLOCATE(INDX1((BASIS_KVEC(PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(PATCH,2)%POLY_ORDER+1)))
		ALLOCATE(SF1(NUMGSPT**2, (BASIS_KVEC(PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(PATCH,2)%POLY_ORDER+1)))
		DO JJ=1, NUMIR(PATCH,2)-1
			DO II=1, NUMIR(PATCH,1)-1
				CALL STIF_LC_INT_II(SF1, WEIGHT, LOAD_F(:), INDX1, PATCH, (/II,JJ/))
				DO I = 1, UBOUND(INDX1,1)
					DO J = 1, UBOUND(INDX1,1)
						CALL STIF_FIND_GLOBAL_INDX_FII(GLOBAL_INDX(1:2), PATCH, (/I,J/), INDX1)
						IF (GLOBAL_INDX(1).NE.0 .AND. GLOBAL_INDX(2).NE.0) THEN
							DIFF_XX = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D10, WEIGHT(:)/), (/NUMGSPT**2, 2/), ORDER=ORDER1), 2), SF1(:,J)%D10)
							DIFF_YY = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D01, WEIGHT(:)/), (/NUMGSPT**2, 2/), ORDER=ORDER1), 2), SF1(:,J)%D01)
							DIFF_YX = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D01, WEIGHT(:)/), (/NUMGSPT**2, 2/), ORDER=ORDER1), 2), SF1(:,J)%D10)
							DIFF_XY = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D10, WEIGHT(:)/), (/NUMGSPT**2, 2/), ORDER=ORDER1), 2), SF1(:,J)%D01)
							
							STIF_K(		 GLOBAL_INDX(1),		GLOBAL_INDX(2)) = STIF_K(		 GLOBAL_INDX(1),		GLOBAL_INDX(2)) + STRESS_E(1,1)*DIFF_XX + STRESS_E(3,3)*DIFF_YY
							STIF_K(DOF+GLOBAL_INDX(1),DOF+GLOBAL_INDX(2)) = STIF_K(DOF+GLOBAL_INDX(1),DOF+GLOBAL_INDX(2)) + STRESS_E(2,2)*DIFF_YY + STRESS_E(3,3)*DIFF_XX
							STIF_K(		 GLOBAL_INDX(1),DOF+GLOBAL_INDX(2)) = STIF_K(		 GLOBAL_INDX(1),DOF+GLOBAL_INDX(2)) + STRESS_E(1,2)*DIFF_XY + STRESS_E(3,3)*DIFF_YX
! 							STIF_K(DOF+GLOBAL_INDX(2),GLOBAL_INDX(1)) = STIF_K(DOF+GLOBAL_INDX(2),GLOBAL_INDX(1)) + STRESS_E(2,1)*DIFF_XY + STRESS_E(3,3)*DIFF_YX
						ENDIF
					ENDDO
					IF (GLOBAL_INDX(1).NE.0) THEN
						DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/NUMGSPT**2, 2/), ORDER=ORDER1), 2), LOAD_F(:)%X)
						STIF_F(GLOBAL_INDX(1)) = STIF_F(GLOBAL_INDX(1)) + DIFF_NN
						DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/NUMGSPT**2, 2/), ORDER=ORDER1), 2), LOAD_F(:)%Y)
						STIF_F(DOF + GLOBAL_INDX(1)) = STIF_F(DOF + GLOBAL_INDX(1)) + DIFF_NN
					ENDIF
				ENDDO
			ENDDO
		ENDDO
		DEALLOCATE(SF1, INDX1)
	ENDDO
	DEALLOCATE(WEIGHT)
! 	PRINT*, 'HERE1', STIF_K(29,29)
! 	READ(*,*)
	!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! IGA - EGM !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
	!! Compute an element on a support intersected between IGA patch and EGM patch
	ALLOCATE(WEIGHT(XIGA_NUMGSPT**2))
	DO IGA_PATCH = 1, NUM_IGA_PATCH
		DO EGM_PATCH = NUM_IGA_PATCH + 1, NUM_PATCH
			
			ALLOCATE(INDX1((BASIS_KVEC(IGA_PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(IGA_PATCH,2)%POLY_ORDER+1)))
			ALLOCATE(INDX2((BASIS_KVEC(EGM_PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(EGM_PATCH,2)%POLY_ORDER+1)))
			
			ALLOCATE(SF1(XIGA_NUMGSPT**2, (BASIS_KVEC(IGA_PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(IGA_PATCH,2)%POLY_ORDER+1)))
			ALLOCATE(SF2(XIGA_NUMGSPT**2, (BASIS_KVEC(EGM_PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(EGM_PATCH,2)%POLY_ORDER+1)))
			
			DO IGA_I = 1, NUMIR(IGA_PATCH,1)-1
				DO IGA_J = 1, NUMIR(IGA_PATCH,2)-1
					
					IRBOX%PT1 = POINT2D(IR_GRID(IGA_PATCH,1,IGA_I), 		 IR_GRID(IGA_PATCH,2,IGA_J))
					IRBOX%PT2 = POINT2D(IR_GRID(IGA_PATCH,1,IGA_I + 1), IR_GRID(IGA_PATCH,2,IGA_J))
					IRBOX%PT3 = POINT2D(IR_GRID(IGA_PATCH,1,IGA_I + 1), IR_GRID(IGA_PATCH,2,IGA_J + 1))
					IRBOX%PT4 = POINT2D(IR_GRID(IGA_PATCH,1,IGA_I), 		 IR_GRID(IGA_PATCH,2,IGA_J + 1))
					
					!-----------------Compute elements (B_i,R_j)---------------------
					DO JJ=1, NUMIR(EGM_PATCH,2)-1
						
						SUB_LN_LENGTH(2) = DABS(IR_GRID(EGM_PATCH,2,JJ+1) - IR_GRID(EGM_PATCH,2,JJ))/(1.D0*NUM_IRBOX(2))
						
						DO EGM_J=1, NUM_IRBOX(2)
							
							LOWER_LIMIT%Y = IR_GRID(EGM_PATCH,2,JJ) + (EGM_J-1)*SUB_LN_LENGTH(2)
							UPPER_LIMIT%Y = IR_GRID(EGM_PATCH,2,JJ) + EGM_J*SUB_LN_LENGTH(2)
							
							DO II=1, NUMIR(EGM_PATCH,1)-1
								
								SUB_LN_LENGTH(1) = DABS(IR_GRID(EGM_PATCH,1,II+1) - IR_GRID(EGM_PATCH,1,II))/(1.D0*NUM_IRBOX(1))
								
								DO EGM_I = 1, NUM_IRBOX(2)
									
									LOWER_LIMIT%X = IR_GRID(EGM_PATCH,1,II) + (EGM_I-1)*SUB_LN_LENGTH(1)
									UPPER_LIMIT%X = IR_GRID(EGM_PATCH,1,II) + EGM_I*SUB_LN_LENGTH(1)
									
									CALL STIF_LC_INT_IJ(SF1, SF2, INDX1, INDX2, WEIGHT, (/IGA_PATCH, EGM_PATCH/), LOWER_LIMIT, UPPER_LIMIT, IRBOX)
									
									DO I = 1, UBOUND(INDX1,1)
										DO J = 1, UBOUND(INDX2,1)
											CALL STIF_FIND_GLOBAL_INDX_FIJ(GLOBAL_INDX(1:2), (/IGA_PATCH, EGM_PATCH/), (/I,J/), INDX1, INDX2)
											IF (GLOBAL_INDX(1).NE.0 .AND. GLOBAL_INDX(2).NE.0) THEN
												DIFF_XX = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D10, WEIGHT(:)/), (/XIGA_NUMGSPT**2, 2/), ORDER=ORDER1), 2), SF2(:,J)%D10)
												DIFF_YY = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D01, WEIGHT(:)/), (/XIGA_NUMGSPT**2, 2/), ORDER=ORDER1), 2), SF2(:,J)%D01)
												DIFF_YX = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D01, WEIGHT(:)/), (/XIGA_NUMGSPT**2, 2/), ORDER=ORDER1), 2), SF2(:,J)%D10)
												DIFF_XY = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D10, WEIGHT(:)/), (/XIGA_NUMGSPT**2, 2/), ORDER=ORDER1), 2), SF2(:,J)%D01)
												
												STIF_K(		 GLOBAL_INDX(1),		GLOBAL_INDX(2)) = STIF_K(		 GLOBAL_INDX(1),		GLOBAL_INDX(2)) + STRESS_E11*DIFF_XX + STRESS_E33*DIFF_YY
												STIF_K(DOF+GLOBAL_INDX(1),DOF+GLOBAL_INDX(2)) = STIF_K(DOF+GLOBAL_INDX(1),DOF+GLOBAL_INDX(2)) + STRESS_E22*DIFF_YY + STRESS_E33*DIFF_XX
												STIF_K(		 GLOBAL_INDX(1),DOF+GLOBAL_INDX(2)) = STIF_K(		 GLOBAL_INDX(1),DOF+GLOBAL_INDX(2)) + STRESS_E12*DIFF_XY + STRESS_E33*DIFF_YX
! 												STIF_K(DOF+GLOBAL_INDX(1),GLOBAL_INDX(2)) = STIF_K(DOF+GLOBAL_INDX(1),GLOBAL_INDX(2)) + STRESS_E21*DIFF_YX + STRESS_E33*DIFF_XY
												
												STIF_K(		 GLOBAL_INDX(2),		GLOBAL_INDX(1)) = STIF_K(		 GLOBAL_INDX(2),		GLOBAL_INDX(1)) + STRESS_E11*DIFF_XX + STRESS_E33*DIFF_YY
												STIF_K(DOF+GLOBAL_INDX(2),DOF+GLOBAL_INDX(1)) = STIF_K(DOF+GLOBAL_INDX(2),DOF+GLOBAL_INDX(1)) + STRESS_E22*DIFF_YY + STRESS_E33*DIFF_XX
												STIF_K(		 GLOBAL_INDX(2),DOF+GLOBAL_INDX(1)) = STIF_K(		 GLOBAL_INDX(2),DOF+GLOBAL_INDX(1)) + STRESS_E12*DIFF_XY + STRESS_E33*DIFF_YX
! 												STIF_K(DOF+GLOBAL_INDX(2),GLOBAL_INDX(1)) = STIF_K(DOF+GLOBAL_INDX(2),GLOBAL_INDX(1)) + STRESS_E21*DIFF_YX + STRESS_E33*DIFF_XY
											ENDIF
! 											PRINT*, 'IGA - EGM', IGA_PATCH, EGM_PATCH, I, J, GLOBAL_INDX(1:2), STIF_K(5,53)
										ENDDO
! 										READ(*,*)
									ENDDO
								ENDDO
							ENDDO
						ENDDO
					ENDDO
				ENDDO
			ENDDO
			DEALLOCATE(SF1, SF2, INDX1, INDX2)
		ENDDO
	ENDDO
	DEALLOCATE(WEIGHT)
	
! 	PRINT*, 'HERE2', STIF_K(29,29)
	
	!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! IGA - INTERFACE / INTERFACE - INTERFACE !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
	ALLOCATE(WEIGHT(NUMGSPT**2))
	DO IGA_PATCH = 1, NUM_IGA_PATCH-1
		DO PATCH = IGA_PATCH+1, NUM_IGA_PATCH
			ALLOCATE(INDX1((BASIS_KVEC(PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(PATCH,2)%POLY_ORDER+1)))
			ALLOCATE(SF1(NUMGSPT**2, (BASIS_KVEC(PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(PATCH,2)%POLY_ORDER+1)))
			DO JJ=1, NUMIR(PATCH,2)-1
				DO II=1, NUMIR(PATCH,1)-1
					CALL STIF_LC_INT_II(SF1, WEIGHT, LOAD_F, INDX1, PATCH, (/II,JJ/))
					DO I = 1, UBOUND(INDX1,1)
						DO J = 1, UBOUND(INDX1,1)
							!! Compute an element on an interface - interface of one same IGA patch
							CALL STIF_FIND_GLOBAL_INDX_ALONG_INTERFACE_FII(GLOBAL_INDX(1:6), (/IGA_PATCH,PATCH/), (/I,J/), INDX1)
							IF ((GLOBAL_INDX(1).NE.0 .AND. GLOBAL_INDX(2).NE.0) .OR. &
									(GLOBAL_INDX(3).NE.0 .AND. GLOBAL_INDX(4).NE.0) .OR. &
									(GLOBAL_INDX(5).NE.0 .AND. GLOBAL_INDX(6).NE.0)) THEN
								DIFF_XX = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D10, WEIGHT(:)/), (/NUMGSPT**2, 2/), ORDER=ORDER1), 2), SF1(:,J)%D10)
								DIFF_YY = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D01, WEIGHT(:)/), (/NUMGSPT**2, 2/), ORDER=ORDER1), 2), SF1(:,J)%D01)
								DIFF_YX = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D01, WEIGHT(:)/), (/NUMGSPT**2, 2/), ORDER=ORDER1), 2), SF1(:,J)%D10)
								DIFF_XY = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D10, WEIGHT(:)/), (/NUMGSPT**2, 2/), ORDER=ORDER1), 2), SF1(:,J)%D01)
								CALL STIF_GET_ELEMENT(STIF_K, GLOBAL_INDX(1:6), DIFF_XX, DIFF_YY, DIFF_XY, DIFF_YX)
							ENDIF
! 							PRINT*, 'IGA-INT HERE 1', IGA_PATCH, PATCH, I, J, GLOBAL_INDX(1:2), STIF_K(4,4)
							!! Compute an element on an interface - interface of two different IGA patches
							CALL STIF_FIND_GLOBAL_INDX_ALONG_INTERFACE_FIJ(GLOBAL_INDX, (/IGA_PATCH,PATCH/), (/I,J/), INDX1)
							IF ((GLOBAL_INDX(1).NE.0 .AND. GLOBAL_INDX(2).NE.0) .OR. &
									(GLOBAL_INDX(3).NE.0 .AND. GLOBAL_INDX(4).NE.0) .OR. &
									(GLOBAL_INDX(5).NE.0 .AND. GLOBAL_INDX(6).NE.0)) THEN
								DIFF_XX = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D10, WEIGHT(:)/), (/NUMGSPT**2, 2/), ORDER=ORDER1), 2), SF1(:,J)%D10)
								DIFF_YY = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D01, WEIGHT(:)/), (/NUMGSPT**2, 2/), ORDER=ORDER1), 2), SF1(:,J)%D01)
								DIFF_YX = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D01, WEIGHT(:)/), (/NUMGSPT**2, 2/), ORDER=ORDER1), 2), SF1(:,J)%D10)
								DIFF_XY = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D10, WEIGHT(:)/), (/NUMGSPT**2, 2/), ORDER=ORDER1), 2), SF1(:,J)%D01)
								CALL STIF_GET_ELEMENT(STIF_K, GLOBAL_INDX(1:6), DIFF_XX, DIFF_YY, DIFF_XY, DIFF_YX, 'SYM')
							ENDIF
! 							PRINT*, 'IGA-INT HERE 2', STIF_K(29,29)
							!! Compute an element on an interface - IGA patch
							CALL STIF_FIND_GLOBAL_INDX_INTERFACE_AND_NONINTERFACE(GLOBAL_INDX, (/IGA_PATCH,PATCH/), (/I,J/), INDX1)
							IF ((GLOBAL_INDX(1).NE.0 .AND. GLOBAL_INDX(2).NE.0) .OR. &
									(GLOBAL_INDX(3).NE.0 .AND. GLOBAL_INDX(4).NE.0) .OR. &
									(GLOBAL_INDX(5).NE.0 .AND. GLOBAL_INDX(6).NE.0)) THEN
								DIFF_XX = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D10, WEIGHT(:)/), (/NUMGSPT**2, 2/), ORDER=ORDER1), 2), SF1(:,J)%D10)
								DIFF_YY = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D01, WEIGHT(:)/), (/NUMGSPT**2, 2/), ORDER=ORDER1), 2), SF1(:,J)%D01)
								DIFF_YX = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D01, WEIGHT(:)/), (/NUMGSPT**2, 2/), ORDER=ORDER1), 2), SF1(:,J)%D10)
								DIFF_XY = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D10, WEIGHT(:)/), (/NUMGSPT**2, 2/), ORDER=ORDER1), 2), SF1(:,J)%D01)
								CALL STIF_GET_ELEMENT(STIF_K, GLOBAL_INDX(1:6), DIFF_XX, DIFF_YY, DIFF_XY, DIFF_YX, 'SYM')
							ENDIF
! 							PRINT*, 'IGA-INT HERE 3', STIF_K(29,29)
						ENDDO
! 						READ(*,*) 
						IF (GLOBAL_INDX(1).NE.0 .OR. GLOBAL_INDX(3).NE.0 .OR. GLOBAL_INDX(5).NE.0) THEN
							DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/NUMGSPT**2, 2/), ORDER=ORDER1), 2), LOAD_F(:)%X)
							CALL LOAD_VC_GET_ELEMENT(STIF_F, GLOBAL_INDX, DIFF_NN, 'U')
							DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/NUMGSPT**2, 2/), ORDER=ORDER1), 2), LOAD_F(:)%Y)
							CALL LOAD_VC_GET_ELEMENT(STIF_F, GLOBAL_INDX, DIFF_NN, 'V')
						ENDIF
					ENDDO
				ENDDO
			ENDDO
			DEALLOCATE(SF1, INDX1)
		ENDDO
	ENDDO
	DEALLOCATE(WEIGHT)
	
! 	PRINT*, 'HERE3', STIF_K(29,29)
	
	!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! EGM - INTERFACE !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
	ALLOCATE(WEIGHT(XIGA_NUMGSPT**2))
	DO EGM_PATCH = NUM_IGA_PATCH + 1, NUM_PATCH
		DO IGA_PATCH = 2, NUM_IGA_PATCH
			ALLOCATE(SF1(XIGA_NUMGSPT**2, (BASIS_KVEC(IGA_PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(IGA_PATCH,2)%POLY_ORDER+1)))
			ALLOCATE(SF2(XIGA_NUMGSPT**2, (BASIS_KVEC(EGM_PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(EGM_PATCH,2)%POLY_ORDER+1)))
			
			ALLOCATE(INDX1((BASIS_KVEC(IGA_PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(IGA_PATCH,2)%POLY_ORDER+1)))
			ALLOCATE(INDX2((BASIS_KVEC(EGM_PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(EGM_PATCH,2)%POLY_ORDER+1)))

			DO IGA_I = 1, NUMIR(IGA_PATCH,1)-1
				DO IGA_J = 1, NUMIR(IGA_PATCH,2)-1
					
					IRBOX%PT1 = POINT2D(IR_GRID(IGA_PATCH,1,IGA_I), 		 IR_GRID(IGA_PATCH,2,IGA_J))
					IRBOX%PT2 = POINT2D(IR_GRID(IGA_PATCH,1,IGA_I + 1), IR_GRID(IGA_PATCH,2,IGA_J))
					IRBOX%PT3 = POINT2D(IR_GRID(IGA_PATCH,1,IGA_I + 1), IR_GRID(IGA_PATCH,2,IGA_J + 1))
					IRBOX%PT4 = POINT2D(IR_GRID(IGA_PATCH,1,IGA_I), 		 IR_GRID(IGA_PATCH,2,IGA_J + 1))
					
					!-----------------Compute elements (B_i,R_j)---------------------
					DO JJ=1, NUMIR(EGM_PATCH,2)-1
						
						SUB_LN_LENGTH(2) = DABS(IR_GRID(EGM_PATCH,2,JJ+1) - IR_GRID(EGM_PATCH,2,JJ))/(1.D0*NUM_IRBOX(2))
						
						DO EGM_J=1, NUM_IRBOX(2)
							
							LOWER_LIMIT%Y = IR_GRID(EGM_PATCH,2,JJ) + (EGM_J-1)*SUB_LN_LENGTH(2)
							UPPER_LIMIT%Y = IR_GRID(EGM_PATCH,2,JJ) + EGM_J*SUB_LN_LENGTH(2)
							
							DO II=1, NUMIR(EGM_PATCH,1)-1
								
								SUB_LN_LENGTH(1) = DABS(IR_GRID(EGM_PATCH,1,II+1) - IR_GRID(EGM_PATCH,1,II))/(1.D0*NUM_IRBOX(1))
								
								DO EGM_I = 1, NUM_IRBOX(2)
									
									LOWER_LIMIT%X = IR_GRID(EGM_PATCH,1,II) + (EGM_I-1)*SUB_LN_LENGTH(1)
									UPPER_LIMIT%X = IR_GRID(EGM_PATCH,1,II) + EGM_I*SUB_LN_LENGTH(1)
									
									CALL STIF_LC_INT_IJ(SF1, SF2, INDX1, INDX2, WEIGHT, (/IGA_PATCH, EGM_PATCH/), LOWER_LIMIT, UPPER_LIMIT, IRBOX)
									
									DO I = 1, UBOUND(INDX1,1)
										DO J = 1, UBOUND(INDX2,1)
											
											CALL STIF_FIND_GLOBAL_INDX_INTERFACE_AND_EGM(GLOBAL_INDX(1:2), (/IGA_PATCH, EGM_PATCH/), (/I,J/), INDX1, INDX2)
											IF (GLOBAL_INDX(1).NE.0 .AND. GLOBAL_INDX(2).NE.0) THEN
												DIFF_XX = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D10, WEIGHT(:)/), (/XIGA_NUMGSPT**2, 2/), ORDER=ORDER1), 2), SF2(:,J)%D10)
												DIFF_YY = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D01, WEIGHT(:)/), (/XIGA_NUMGSPT**2, 2/), ORDER=ORDER1), 2), SF2(:,J)%D01)
												DIFF_YX = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D01, WEIGHT(:)/), (/XIGA_NUMGSPT**2, 2/), ORDER=ORDER1), 2), SF2(:,J)%D10)
												DIFF_XY = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D10, WEIGHT(:)/), (/XIGA_NUMGSPT**2, 2/), ORDER=ORDER1), 2), SF2(:,J)%D01)
												
												STIF_K(		 GLOBAL_INDX(1),		GLOBAL_INDX(2)) = STIF_K(		 GLOBAL_INDX(1),		GLOBAL_INDX(2)) + STRESS_E11*DIFF_XX + STRESS_E33*DIFF_YY
												STIF_K(DOF+GLOBAL_INDX(1),DOF+GLOBAL_INDX(2)) = STIF_K(DOF+GLOBAL_INDX(1),DOF+GLOBAL_INDX(2)) + STRESS_E22*DIFF_YY + STRESS_E33*DIFF_XX
												STIF_K(		 GLOBAL_INDX(1),DOF+GLOBAL_INDX(2)) = STIF_K(		 GLOBAL_INDX(1),DOF+GLOBAL_INDX(2)) + STRESS_E12*DIFF_XY + STRESS_E33*DIFF_YX
! 												STIF_K(DOF+GLOBAL_INDX(1),GLOBAL_INDX(2)) = STIF_K(DOF+GLOBAL_INDX(1),GLOBAL_INDX(2)) + STRESS_E21*DIFF_YX + STRESS_E33*DIFF_XY
												
												STIF_K(		 GLOBAL_INDX(2),		GLOBAL_INDX(1)) = STIF_K(		 GLOBAL_INDX(2),		GLOBAL_INDX(1)) + STRESS_E11*DIFF_XX + STRESS_E33*DIFF_YY
												STIF_K(DOF+GLOBAL_INDX(2),DOF+GLOBAL_INDX(1)) = STIF_K(DOF+GLOBAL_INDX(2),DOF+GLOBAL_INDX(1)) + STRESS_E22*DIFF_YY + STRESS_E33*DIFF_XX
												STIF_K(		 GLOBAL_INDX(2),DOF+GLOBAL_INDX(1)) = STIF_K(		 GLOBAL_INDX(2),DOF+GLOBAL_INDX(1)) + STRESS_E12*DIFF_XY + STRESS_E33*DIFF_YX
! 												STIF_K(DOF+GLOBAL_INDX(2),GLOBAL_INDX(1)) = STIF_K(DOF+GLOBAL_INDX(2),GLOBAL_INDX(1)) + STRESS_E21*DIFF_YX + STRESS_E33*DIFF_XY
											ENDIF
				! 							PRINT*, 'IGA - EGM', IGA_PATCH, EGM_PATCH, I, J, GLOBAL_INDX(1:2), STIF_K(5,53)
										ENDDO
				! 						READ(*,*)
									ENDDO
								ENDDO
							ENDDO
						ENDDO
					ENDDO
				ENDDO
			ENDDO
			DEALLOCATE(SF1, INDX1, SF2, INDX2)
		ENDDO
	ENDDO
	DEALLOCATE(WEIGHT)
	
	DO I = DOF + 1, 2*DOF
		DO J = 1, DOF
			STIF_K(I,J) = STIF_K(J,I)
		ENDDO
	ENDDO

! 	PRINT*, 'HERE4', STIF_K(29,29)

	WRITE(*,*)
	WRITE(*,*) '<<< ASSEMBLE STIFFNESS MATRIX AND LOAD VECTOR : DONE >>>'
	WRITE(*,*)
	
END SUBROUTINE GEN_KF

SUBROUTINE GEN_BD_LN(SUB_K, SUB_F)

	REAL*8, INTENT(OUT) :: SUB_K(SUM(DR_BDNDX(:,1)%LC_NUM), SUM(DR_BDNDX(:,1)%LC_NUM))
	TYPE(POINT2D), INTENT(OUT) :: SUB_F(SUM(DR_BDNDX(:,1)%LC_NUM))
	TYPE(POINT2D), ALLOCATABLE :: EXACT_ON_BD(:)
	TYPE(FVALUE), ALLOCATABLE :: SF1(:,:), SF2(:,:), SN_SF(:,:)
	TYPE(INT2D), ALLOCATABLE :: INDX1(:), INDX2(:), SN_INDX(:)
	TYPE(VEC2D), ALLOCATABLE :: GEO_MESH(:)
	REAL*8, ALLOCATABLE :: SN_WEIGHT(:)
	TYPE(POINT2D) :: BDPT(2)

	REAL*8 :: DIFF_NN, DET_M, SUB_LN_LENGTH
	INTEGER :: I, J, II, JJ, KK, GLOBAL_INDX(6), PATCH, IGA_PATCH, EGM_PATCH, SUB_NUMLN, MASTER_PATCH, SLAVE_PATCH
	INTEGER :: IGA_I, IGA_J, GLOBAL_I, GLOBAL_J, TS_I, TS_J, SN_FACTOR
	TYPE(VEC2D) :: SUB_LN, SUPP_IGA
	TYPE(MATRIX_22) :: JACOB
	
	SUB_K(:,:)=0.D0; SUB_F(:) = POINT2D(0.D0,0.D0); SUB_NUMLN = 5; LN_NUMGSPT = 18; SN_FACTOR = 3

	TS_I = 1; TS_J = 14
	
	ALLOCATE(GEO_MESH(SUB_NUMLN+1))
	
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
	ALLOCATE(WEIGHT(NUMGSPT))
	ALLOCATE(EXACT_ON_BD(UBOUND(WEIGHT,1)))
	DO PATCH = 1, NUM_PATCH
		ALLOCATE(SF1(UBOUND(WEIGHT,1), (BASIS_KVEC(PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(PATCH,2)%POLY_ORDER+1)))
		ALLOCATE(INDX1((BASIS_KVEC(PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(PATCH,2)%POLY_ORDER+1)))
		DO JJ = 1, NUMIR(PATCH,2)-1
			IF (PATCH.EQ.2 .OR. PATCH.EQ.3 .OR. PATCH.EQ.4) THEN		! LEFT
			!----------------------- LEFT SIDE ON THE PARAMETER SPACE ------------------------!
				SUB_LN = VEC2D(POINT2D(0.D0,IR_GRID(PATCH,2,JJ)), POINT2D(0.D0,IR_GRID(PATCH,2,JJ+1)))
				CALL LEAST_SQUARE_LC_INT_II(SF1, INDX1, WEIGHT, EXACT_ON_BD, PATCH, SUB_LN, 'L')
				DO I=1, UBOUND(INDX1,1)
					DO J=1, UBOUND(INDX1,1)
						DIFF_NN = 0.D0
						CALL DR_GL_INDX_FII(GLOBAL_INDX(1:2), PATCH, (/I,J/), INDX1)
						IF (GLOBAL_INDX(1).EQ.0 .OR. GLOBAL_INDX(2).EQ.0) THEN
						ELSE
							DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), SF1(:,J)%D00)
							SUB_K(GLOBAL_INDX(1), GLOBAL_INDX(2)) = SUB_K(GLOBAL_INDX(1), GLOBAL_INDX(2)) + DIFF_NN
						ENDIF
					ENDDO
					IF (GLOBAL_INDX(1).EQ.0) THEN
					ELSE
						DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), EXACT_ON_BD(:)%X)
						SUB_F(GLOBAL_INDX(1))%X = SUB_F(GLOBAL_INDX(1))%X + DIFF_NN
						DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), EXACT_ON_BD(:)%Y)
						SUB_F(GLOBAL_INDX(1))%Y = SUB_F(GLOBAL_INDX(1))%Y + DIFF_NN
					ENDIF
				ENDDO
					
! 					PRINT*, 'LF-1', PATCH, JJ, SUB_K(TS_I,TS_J), SUB_F(TS_J)%Y
				
				DO MASTER_PATCH = 1, PATCH-1
				!-----------------Compute elements on interface (i.e. FII)---------------------
					DO I = 1, UBOUND(INDX1,1)
						DO J = 1, UBOUND(INDX1,1)
							CALL DR_FIND_GL_INDX_ALONG_INTERFACE_FII(GLOBAL_INDX(1:6), (/MASTER_PATCH, PATCH/), (/I,J/), INDX1)
							IF ((GLOBAL_INDX(1).NE.0 .AND. GLOBAL_INDX(2).NE.0) .OR. &
									(GLOBAL_INDX(3).NE.0 .AND. GLOBAL_INDX(4).NE.0) .OR. &
									(GLOBAL_INDX(5).NE.0 .AND. GLOBAL_INDX(6).NE.0)) THEN
		! 					PRINT*, 'HERE 1', GLOBAL_INDX
								DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), SF1(:,J)%D00)
								DO GLOBAL_I = 1, 3
									IF (GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)).NE.0 .AND. GLOBAL_INDX(INT(2*GLOBAL_I)).NE.0) THEN
										SUB_K(GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)), GLOBAL_INDX(INT(2*GLOBAL_I))) = SUB_K(GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)), GLOBAL_INDX(INT(2*GLOBAL_I))) + DIFF_NN
									ENDIF
								ENDDO
							ENDIF
						ENDDO
! 							CALL DR_FIND_GL_INDX_ALONG_INTERFACE_FII(GLOBAL_INDX(1:6), (/MASTER_PATCH, PATCH/), (/I,I/), INDX1)
						IF (GLOBAL_INDX(1).NE.0 .OR. GLOBAL_INDX(3).NE.0 .OR. GLOBAL_INDX(5).NE.0) THEN
							DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), EXACT_ON_BD(:)%X)
							DO GLOBAL_I = 1, 3
								IF (GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)).NE.0) THEN
									SUB_F(GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)))%X = SUB_F(GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)))%X + DIFF_NN
								ENDIF
							ENDDO
							DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), EXACT_ON_BD(:)%Y)
							DO GLOBAL_I = 1, 3
								IF (GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)).NE.0) THEN
									SUB_F(GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)))%Y = SUB_F(GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)))%Y + DIFF_NN
								ENDIF
							ENDDO
						ENDIF
					ENDDO
						
! 						PRINT*, 'LF-2', PATCH, JJ, SUB_K(TS_I,TS_J), SUB_F(TS_J)%Y
						
					!-----------------Compute elements on interface FIJ---------------------
					DO I = 1, UBOUND(INDX1,1)
						DO J = 1, UBOUND(INDX1,1)
							CALL DR_FIND_GL_INDX_ALONG_INTERFACE_FIJ(GLOBAL_INDX(1:2), (/MASTER_PATCH, PATCH/), (/I,J/), INDX1)
							IF (GLOBAL_INDX(1).EQ.0 .OR. GLOBAL_INDX(2).EQ.0) THEN
							ELSE
		! 								PRINT*, 'HERE 2', GLOBAL_INDX
								DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), SF1(:,J)%D00)
								SUB_K(GLOBAL_INDX(1), GLOBAL_INDX(2)) = SUB_K(GLOBAL_INDX(1), GLOBAL_INDX(2)) + DIFF_NN
								SUB_K(GLOBAL_INDX(2), GLOBAL_INDX(1)) = SUB_K(GLOBAL_INDX(2), GLOBAL_INDX(1)) + DIFF_NN
							ENDIF
						ENDDO
					ENDDO
					
! 						PRINT*, 'LF-3', PATCH, JJ, SUB_K(TS_I,TS_J), SUB_F(TS_J)%Y

! 						READ(*,*)
				ENDDO
			ENDIF
		ENDDO
		DEALLOCATE(SF1, INDX1)
	ENDDO
	DEALLOCATE(WEIGHT, EXACT_ON_BD)
				
! 			PRINT*, 'LF-4', PATCH, JJ, SUB_K(TS_I,TS_J), SUB_F(TS_J)%Y

	ALLOCATE(WEIGHT(NUMGSPT))
	ALLOCATE(EXACT_ON_BD(UBOUND(WEIGHT,1)))
	DO PATCH = 1, NUM_PATCH
		ALLOCATE(SF1(UBOUND(WEIGHT,1), (BASIS_KVEC(PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(PATCH,2)%POLY_ORDER+1)))
		ALLOCATE(INDX1((BASIS_KVEC(PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(PATCH,2)%POLY_ORDER+1)))
		DO JJ = 1, NUMIR(PATCH,2)-1
			IF (PATCH.EQ.1 .OR. PATCH.EQ.4) THEN		! RIGHT
			!----------------------- RIGHT SIDE ON THE PARAMETER SPACE ------------------------!
				SUB_LN = VEC2D(POINT2D(1.D0,IR_GRID(PATCH,2,JJ)), POINT2D(1.D0,IR_GRID(PATCH,2,JJ+1)))
				DIFF_NN = 0.D0
				CALL LEAST_SQUARE_LC_INT_II(SF1, INDX1, WEIGHT, EXACT_ON_BD, PATCH, SUB_LN, 'R')
				DO I=1, UBOUND(INDX1,1)
					DO J=1, UBOUND(INDX1,1)
						CALL DR_GL_INDX_FII(GLOBAL_INDX(1:2), PATCH, (/I,J/), INDX1)
						IF (GLOBAL_INDX(1).EQ.0 .OR. GLOBAL_INDX(2).EQ.0) THEN
						ELSE
							DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), SF1(:,J)%D00)
							SUB_K(GLOBAL_INDX(1), GLOBAL_INDX(2)) = SUB_K(GLOBAL_INDX(1), GLOBAL_INDX(2)) + DIFF_NN
						ENDIF
					ENDDO
					IF (GLOBAL_INDX(1).EQ.0) THEN
					ELSE
						DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), EXACT_ON_BD(:)%X)
						SUB_F(GLOBAL_INDX(1))%X = SUB_F(GLOBAL_INDX(1))%X + DIFF_NN
						DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), EXACT_ON_BD(:)%Y)
						SUB_F(GLOBAL_INDX(1))%Y = SUB_F(GLOBAL_INDX(1))%Y + DIFF_NN
					ENDIF
				ENDDO
				
! 				PRINT*, 'RG-1', PATCH, JJ, SUB_K(TS_I,TS_J), SUB_F(TS_J)%Y
				
				DO MASTER_PATCH = 1, PATCH-1
				!-----------------Compute elements on interface (i.e. FII)---------------------
					DO I = 1, UBOUND(INDX1,1)
						DO J = 1, UBOUND(INDX1,1)
							CALL DR_FIND_GL_INDX_ALONG_INTERFACE_FII(GLOBAL_INDX(1:6), (/MASTER_PATCH, PATCH/), (/I,J/), INDX1)
							IF ((GLOBAL_INDX(1).NE.0 .AND. GLOBAL_INDX(2).NE.0) .OR. &
									(GLOBAL_INDX(3).NE.0 .AND. GLOBAL_INDX(4).NE.0) .OR. &
									(GLOBAL_INDX(5).NE.0 .AND. GLOBAL_INDX(6).NE.0)) THEN
								DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), SF1(:,J)%D00)
								DO GLOBAL_I = 1, 3
									IF (GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)).NE.0 .AND. GLOBAL_INDX(INT(2*GLOBAL_I)).NE.0) THEN
										SUB_K(GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)), GLOBAL_INDX(INT(2*GLOBAL_I))) = SUB_K(GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)), GLOBAL_INDX(INT(2*GLOBAL_I))) + DIFF_NN
									ENDIF
								ENDDO
							ENDIF
						ENDDO
! 							CALL DR_FIND_GL_INDX_ALONG_INTERFACE_FII(GLOBAL_INDX(1:6), (/MASTER_PATCH, PATCH/), (/I,I/), INDX1)
						IF (GLOBAL_INDX(1).NE.0 .OR. GLOBAL_INDX(3).NE.0 .OR. GLOBAL_INDX(5).NE.0) THEN
							DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), EXACT_ON_BD(:)%X)
							DO GLOBAL_I = 1, 3
								IF (GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)).NE.0) THEN
									SUB_F(GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)))%X = SUB_F(GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)))%X + DIFF_NN
								ENDIF
							ENDDO
							DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), EXACT_ON_BD(:)%Y)
							DO GLOBAL_I = 1, 3
								IF (GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)).NE.0) THEN
									SUB_F(GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)))%Y = SUB_F(GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)))%Y + DIFF_NN
								ENDIF
							ENDDO
						ENDIF
					ENDDO
					
! 					PRINT*, 'RG-2', PATCH, JJ, SUB_K(TS_I,TS_J), SUB_F(TS_J)%Y
					
					!-----------------Compute elements on interface FIJ---------------------
					DO I = 1, UBOUND(INDX1,1)
						DO J = 1, UBOUND(INDX1,1)
							CALL DR_FIND_GL_INDX_ALONG_INTERFACE_FIJ(GLOBAL_INDX(1:2), (/MASTER_PATCH, PATCH/), (/I,J/), INDX1)
							IF (GLOBAL_INDX(1).EQ.0 .OR. GLOBAL_INDX(2).EQ.0) THEN
							ELSE
		! 								PRINT*, 'HERE 2', GLOBAL_INDX
								DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), SF1(:,J)%D00)
								SUB_K(GLOBAL_INDX(1), GLOBAL_INDX(2)) = SUB_K(GLOBAL_INDX(1), GLOBAL_INDX(2)) + DIFF_NN
								SUB_K(GLOBAL_INDX(2), GLOBAL_INDX(1)) = SUB_K(GLOBAL_INDX(2), GLOBAL_INDX(1)) + DIFF_NN
							ENDIF
						ENDDO
					ENDDO
					
! 					PRINT*, 'RG-3', PATCH, JJ, SUB_K(TS_I,TS_J), SUB_F(TS_J)%Y
					
				ENDDO
			ENDIF
		ENDDO
		DEALLOCATE(SF1, INDX1)
	ENDDO
	DEALLOCATE(WEIGHT, EXACT_ON_BD)
	
! 	PRINT*, 'RG-4', PATCH, JJ, SUB_K(TS_I,TS_J), SUB_F(TS_J)%Y
	
	!----------------------------------------------!
	!! LINE INTEGRAL WITH GEOMETRIC MESH REFINEMENT
	!----------------------------------------------!
	ALLOCATE(WEIGHT(NUMGSPT), SN_WEIGHT(NUMGSPT))
	ALLOCATE(EXACT_ON_BD(UBOUND(WEIGHT,1)))
	DO PATCH = 1, NUM_PATCH
		ALLOCATE(SF1(UBOUND(WEIGHT,1), (BASIS_KVEC(PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(PATCH,2)%POLY_ORDER+1)))
		ALLOCATE(INDX1((BASIS_KVEC(PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(PATCH,2)%POLY_ORDER+1)))
		ALLOCATE(SN_SF(UBOUND(SN_WEIGHT,1), (BASIS_KVEC(PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(PATCH,2)%POLY_ORDER+1)))
		ALLOCATE(SN_INDX((BASIS_KVEC(PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(PATCH,2)%POLY_ORDER+1)))
		DO JJ = 1, NUMIR(PATCH,2)-1
			IF (PATCH.EQ.3) THEN		! RIGHT with Singular load function
			!----------------------- RIGHT SIDE ON THE PARAMETER SPACE ------------------------!
				SUB_LN = VEC2D(POINT2D(1.D0,IR_GRID(PATCH,2,JJ)), POINT2D(1.D0,IR_GRID(PATCH,2,JJ+1)))
				DIFF_NN = 0.D0
				CALL LEAST_SQUARE_LC_INT_II(SF1, INDX1, WEIGHT, EXACT_ON_BD, PATCH, SUB_LN, 'R')
				CALL LN_INT_BY_MAM(SN_SF, SN_INDX, SN_WEIGHT, EXACT_ON_BD, PATCH, SUB_LN, SN_FACTOR, 'R')
				DO I=1, UBOUND(INDX1,1)
					DO J=1, UBOUND(INDX1,1)
						CALL DR_GL_INDX_FII(GLOBAL_INDX(1:2), PATCH, (/I,J/), INDX1)
						IF (GLOBAL_INDX(1).EQ.0 .OR. GLOBAL_INDX(2).EQ.0) THEN
						ELSE
							DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), SF1(:,J)%D00)
							SUB_K(GLOBAL_INDX(1), GLOBAL_INDX(2)) = SUB_K(GLOBAL_INDX(1), GLOBAL_INDX(2)) + DIFF_NN
						ENDIF
					ENDDO
					IF (GLOBAL_INDX(1).EQ.0) THEN
					ELSE
						DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SN_SF(:,I)%D00, SN_WEIGHT(:)/), (/UBOUND(SN_WEIGHT,1), 2/), ORDER=ORDER1), 2), EXACT_ON_BD(:)%X)
						SUB_F(GLOBAL_INDX(1))%X = SUB_F(GLOBAL_INDX(1))%X + DIFF_NN
						DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SN_SF(:,I)%D00, SN_WEIGHT(:)/), (/UBOUND(SN_WEIGHT,1), 2/), ORDER=ORDER1), 2), EXACT_ON_BD(:)%Y)
						SUB_F(GLOBAL_INDX(1))%Y = SUB_F(GLOBAL_INDX(1))%Y + DIFF_NN
					ENDIF
				ENDDO
				
! 					PRINT*, 'RS-1', PATCH, JJ, SUB_K(TS_I,TS_J), SUB_F(TS_J)%Y
				
				DO MASTER_PATCH = 1, PATCH-1
				!-----------------Compute elements on interface (i.e. FII)---------------------
					DO I = 1, UBOUND(INDX1,1)
						DO J = 1, UBOUND(INDX1,1)
							CALL DR_FIND_GL_INDX_ALONG_INTERFACE_FII(GLOBAL_INDX(1:6), (/MASTER_PATCH, PATCH/), (/I,J/), INDX1)
							IF ((GLOBAL_INDX(1).NE.0 .AND. GLOBAL_INDX(2).NE.0) .OR. &
									(GLOBAL_INDX(3).NE.0 .AND. GLOBAL_INDX(4).NE.0) .OR. &
									(GLOBAL_INDX(5).NE.0 .AND. GLOBAL_INDX(6).NE.0)) THEN
		! 					PRINT*, 'HERE 1', GLOBAL_INDX
								DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), SF1(:,J)%D00)
								DO GLOBAL_I = 1, 3
									IF (GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)).NE.0 .AND. GLOBAL_INDX(INT(2*GLOBAL_I)).NE.0) THEN
										SUB_K(GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)), GLOBAL_INDX(INT(2*GLOBAL_I))) = SUB_K(GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)), GLOBAL_INDX(INT(2*GLOBAL_I))) + DIFF_NN
									ENDIF
								ENDDO
							ENDIF
						ENDDO
! 							CALL DR_FIND_GL_INDX_ALONG_INTERFACE_FII(GLOBAL_INDX(1:6), (/MASTER_PATCH, PATCH/), (/I,I/), INDX1)
						IF (GLOBAL_INDX(1).NE.0 .OR. GLOBAL_INDX(3).NE.0 .OR. GLOBAL_INDX(5).NE.0) THEN
							DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SN_SF(:,I)%D00, SN_WEIGHT(:)/), (/UBOUND(SN_WEIGHT,1), 2/), ORDER=ORDER1), 2), EXACT_ON_BD(:)%X)
							DO GLOBAL_I = 1, 3
								IF (GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)).NE.0) THEN
									SUB_F(GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)))%X = SUB_F(GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)))%X + DIFF_NN
								ENDIF
							ENDDO
							DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SN_SF(:,I)%D00, SN_WEIGHT(:)/), (/UBOUND(SN_WEIGHT,1), 2/), ORDER=ORDER1), 2), EXACT_ON_BD(:)%Y)
							DO GLOBAL_I = 1, 3
								IF (GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)).NE.0) THEN
									SUB_F(GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)))%Y = SUB_F(GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)))%Y + DIFF_NN
								ENDIF
							ENDDO
						ENDIF
					ENDDO
					
! 						PRINT*, 'RS-2', PATCH, JJ, SUB_K(TS_I,TS_J), SUB_F(TS_J)%Y
					
					!-----------------Compute elements on interface FIJ---------------------
					DO I = 1, UBOUND(INDX1,1)
						DO J = 1, UBOUND(INDX1,1)
							CALL DR_FIND_GL_INDX_ALONG_INTERFACE_FIJ(GLOBAL_INDX(1:2), (/MASTER_PATCH, PATCH/), (/I,J/), INDX1)
							IF (GLOBAL_INDX(1).EQ.0 .OR. GLOBAL_INDX(2).EQ.0) THEN
							ELSE
		! 								PRINT*, 'HERE 2', GLOBAL_INDX
								DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), SF1(:,J)%D00)
								SUB_K(GLOBAL_INDX(1), GLOBAL_INDX(2)) = SUB_K(GLOBAL_INDX(1), GLOBAL_INDX(2)) + DIFF_NN
								SUB_K(GLOBAL_INDX(2), GLOBAL_INDX(1)) = SUB_K(GLOBAL_INDX(2), GLOBAL_INDX(1)) + DIFF_NN
							ENDIF
						ENDDO
					ENDDO
					
! 						PRINT*, 'RS-3', PATCH, JJ, SUB_K(TS_I,TS_J), SUB_F(TS_J)%Y
					
				ENDDO
			ENDIF
		ENDDO
		DEALLOCATE(SF1, INDX1, SN_SF, SN_INDX)
	ENDDO
	DEALLOCATE(WEIGHT, SN_WEIGHT, EXACT_ON_BD)
	
! 	PRINT*, 'RS-4', PATCH, JJ, SUB_K(TS_I,TS_J), SUB_F(TS_J)%Y
	
	ALLOCATE(WEIGHT(NUMGSPT))
	ALLOCATE(EXACT_ON_BD(UBOUND(WEIGHT,1)))
	DO PATCH = 1, NUM_PATCH
		ALLOCATE(SF1(UBOUND(WEIGHT,1), (BASIS_KVEC(PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(PATCH,2)%POLY_ORDER+1)))
		ALLOCATE(INDX1((BASIS_KVEC(PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(PATCH,2)%POLY_ORDER+1)))
		DO JJ = 1, NUMIR(PATCH,1)-1
			IF (PATCH==3) THEN		! BOTTOM
			!----------------------- BOTTOM SIDE ON THE PARAMETER SPACE ------------------------!
				DIFF_NN = 0.D0
				SUB_LN = VEC2D(POINT2D(IR_GRID(PATCH,1,JJ),0.D0), POINT2D(IR_GRID(PATCH,1,JJ+1),0.D0))
				CALL LEAST_SQUARE_LC_INT_II(SF1, INDX1, WEIGHT, EXACT_ON_BD, PATCH, SUB_LN, 'B')
				DO I=1, UBOUND(INDX1,1)
					DO J=1, UBOUND(INDX1,1)
						CALL DR_GL_INDX_FII(GLOBAL_INDX(1:2), PATCH, (/I,J/), INDX1)
						IF (GLOBAL_INDX(1).EQ.0 .OR. GLOBAL_INDX(2).EQ.0) THEN
						ELSE
							DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), SF1(:,J)%D00)
							SUB_K(GLOBAL_INDX(1), GLOBAL_INDX(2)) = SUB_K(GLOBAL_INDX(1), GLOBAL_INDX(2)) + DIFF_NN
						ENDIF
					ENDDO
					IF (GLOBAL_INDX(1).EQ.0) THEN
					ELSE
						DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), EXACT_ON_BD(:)%X)
						SUB_F(GLOBAL_INDX(1))%X = SUB_F(GLOBAL_INDX(1))%X + DIFF_NN
						DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), EXACT_ON_BD(:)%Y)
						SUB_F(GLOBAL_INDX(1))%Y = SUB_F(GLOBAL_INDX(1))%Y + DIFF_NN
					ENDIF
				ENDDO
				
! 				PRINT*, 'BT-1', PATCH, JJ, SUB_K(TS_I,TS_J), SUB_F(TS_J)%Y
				
				DO MASTER_PATCH = 1, PATCH-1
				!-----------------Compute elements on interface (i.e. FII)---------------------
					DO I = 1, UBOUND(INDX1,1)
						DO J = 1, UBOUND(INDX1,1)
							CALL DR_FIND_GL_INDX_ALONG_INTERFACE_FII(GLOBAL_INDX(1:6), (/MASTER_PATCH, PATCH/), (/I,J/), INDX1)
							IF ((GLOBAL_INDX(1).NE.0 .AND. GLOBAL_INDX(2).NE.0) .OR. &
									(GLOBAL_INDX(3).NE.0 .AND. GLOBAL_INDX(4).NE.0) .OR. &
									(GLOBAL_INDX(5).NE.0 .AND. GLOBAL_INDX(6).NE.0)) THEN
		! 					PRINT*, 'HERE 1', GLOBAL_INDX
								DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), SF1(:,J)%D00)
								DO GLOBAL_I = 1, 3
									IF (GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)).NE.0 .AND. GLOBAL_INDX(INT(2*GLOBAL_I)).NE.0) THEN
										SUB_K(GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)), GLOBAL_INDX(INT(2*GLOBAL_I))) = SUB_K(GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)), GLOBAL_INDX(INT(2*GLOBAL_I))) + DIFF_NN
									ENDIF
								ENDDO
							ENDIF
						ENDDO
! 							CALL DR_FIND_GL_INDX_ALONG_INTERFACE_FII(GLOBAL_INDX(1:6), (/MASTER_PATCH, PATCH/), (/I,I/), INDX1)
						IF (GLOBAL_INDX(1).NE.0 .OR. GLOBAL_INDX(3).NE.0 .OR. GLOBAL_INDX(5).NE.0) THEN
							DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), EXACT_ON_BD(:)%X)
							DO GLOBAL_I = 1, 3
								IF (GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)).NE.0) THEN
									SUB_F(GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)))%X = SUB_F(GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)))%X + DIFF_NN
								ENDIF
							ENDDO
							DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), EXACT_ON_BD(:)%Y)
							DO GLOBAL_I = 1, 3
								IF (GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)).NE.0) THEN
									SUB_F(GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)))%Y = SUB_F(GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)))%Y + DIFF_NN
								ENDIF
							ENDDO
						ENDIF
					ENDDO
					
! 					PRINT*, 'BT-2', PATCH, JJ, SUB_K(TS_I,TS_J), SUB_F(TS_J)%Y
					
					!-----------------Compute elements on interface FIJ---------------------
					DO I = 1, UBOUND(INDX1,1)
						DO J = 1, UBOUND(INDX1,1)
							CALL DR_FIND_GL_INDX_ALONG_INTERFACE_FIJ(GLOBAL_INDX(1:2), (/MASTER_PATCH, PATCH/), (/I,J/), INDX1)
							IF (GLOBAL_INDX(1).EQ.0 .OR. GLOBAL_INDX(2).EQ.0) THEN
							ELSE
		! 								PRINT*, 'HERE 2', GLOBAL_INDX
								DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), SF1(:,J)%D00)
								SUB_K(GLOBAL_INDX(1), GLOBAL_INDX(2)) = SUB_K(GLOBAL_INDX(1), GLOBAL_INDX(2)) + DIFF_NN
								SUB_K(GLOBAL_INDX(2), GLOBAL_INDX(1)) = SUB_K(GLOBAL_INDX(2), GLOBAL_INDX(1)) + DIFF_NN
							ENDIF
						ENDDO
					ENDDO
					
! 					PRINT*, 'BT-3', PATCH, JJ, SUB_K(TS_I,TS_J), SUB_F(TS_J)%Y
					
				ENDDO
			ENDIF
		ENDDO
		DEALLOCATE(SF1, INDX1)
	ENDDO
	DEALLOCATE(WEIGHT, EXACT_ON_BD)

! 	PRINT*, 'BT-4', PATCH, JJ, SUB_K(TS_I,TS_J), SUB_F(TS_J)%Y
	
	!----------------------------------------------!
	!! LINE INTEGRAL WITH GEOMETRIC MESH REFINEMENT
	!----------------------------------------------!
	ALLOCATE(WEIGHT(LN_NUMGSPT))
	ALLOCATE(EXACT_ON_BD(UBOUND(WEIGHT,1)))
	DO PATCH = 1, NUM_PATCH
		ALLOCATE(SF1(UBOUND(WEIGHT,1), (BASIS_KVEC(PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(PATCH,2)%POLY_ORDER+1)))
		ALLOCATE(INDX1((BASIS_KVEC(PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(PATCH,2)%POLY_ORDER+1)))
		DO JJ = 1, NUMIR(PATCH,1)-1
			IF (PATCH==1) THEN		! BOTTOM with Singular load function
			!----------------------- BOTTOM SIDE ON THE PARAMETER SPACE ------------------------!
				OPEN(14, FILE = './data/geo_mesh2')
				GEO_MESH(1) = VEC2D(POINT2D(IR_GRID(PATCH,1,JJ), 0.D0), &
														POINT2D(IR_GRID(PATCH,1,JJ) + (IR_GRID(PATCH,1,JJ+1) - IR_GRID(PATCH,1,JJ))*(0.5D0)**(SUB_NUMLN), 0.D0))
				
				WRITE(14,*) GEO_MESH(1)%U
				WRITE(14,*) GEO_MESH(1)%V
				
				DO I = 1, SUB_NUMLN
					GEO_MESH(I+1) = VEC2D(POINT2D(IR_GRID(PATCH,1,JJ) + (IR_GRID(PATCH,1,JJ+1) - IR_GRID(PATCH,1,JJ))*(0.5D0)**(SUB_NUMLN-I+1), 0.D0), &
															POINT2D(IR_GRID(PATCH,1,JJ) + (IR_GRID(PATCH,1,JJ+1) - IR_GRID(PATCH,1,JJ))*(0.5D0)**(SUB_NUMLN-I), 0.D0))
					WRITE(14,*) GEO_MESH(I+1)%U
					WRITE(14,*) GEO_MESH(I+1)%V
				ENDDO
				
				DIFF_NN = 0.D0
				DO II = 1, SUB_NUMLN + 1
					CALL LEAST_SQUARE_LC_INT_II(SF1, INDX1, WEIGHT, EXACT_ON_BD, PATCH, GEO_MESH(II), 'B')
					DO I=1, UBOUND(INDX1,1)
						DO J=1, UBOUND(INDX1,1)
							CALL DR_GL_INDX_FII(GLOBAL_INDX(1:2), PATCH, (/I,J/), INDX1)
							IF (GLOBAL_INDX(1).EQ.0 .OR. GLOBAL_INDX(2).EQ.0) THEN
							ELSE
								DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), SF1(:,J)%D00)
								SUB_K(GLOBAL_INDX(1), GLOBAL_INDX(2)) = SUB_K(GLOBAL_INDX(1), GLOBAL_INDX(2)) + DIFF_NN
							ENDIF
						ENDDO
						IF (GLOBAL_INDX(1).EQ.0) THEN
						ELSE
							DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), EXACT_ON_BD(:)%X)
							SUB_F(GLOBAL_INDX(1))%X = SUB_F(GLOBAL_INDX(1))%X + DIFF_NN
							DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), EXACT_ON_BD(:)%Y)
							SUB_F(GLOBAL_INDX(1))%Y = SUB_F(GLOBAL_INDX(1))%Y + DIFF_NN
						ENDIF
					ENDDO
					
! 					PRINT*, 'BS-1', PATCH, JJ, SUB_K(TS_I,TS_J), SUB_F(TS_J)%Y
					
					DO MASTER_PATCH = 1, PATCH-1
					!-----------------Compute elements on interface (i.e. FII)---------------------
						DO I = 1, UBOUND(INDX1,1)
							DO J = 1, UBOUND(INDX1,1)
								CALL DR_FIND_GL_INDX_ALONG_INTERFACE_FII(GLOBAL_INDX(1:6), (/MASTER_PATCH, PATCH/), (/I,J/), INDX1)
								IF ((GLOBAL_INDX(1).NE.0 .AND. GLOBAL_INDX(2).NE.0) .OR. &
										(GLOBAL_INDX(3).NE.0 .AND. GLOBAL_INDX(4).NE.0) .OR. &
										(GLOBAL_INDX(5).NE.0 .AND. GLOBAL_INDX(6).NE.0)) THEN
			! 					PRINT*, 'HERE 1', GLOBAL_INDX
									DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), SF1(:,J)%D00)
									DO GLOBAL_I = 1, 3
										IF (GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)).NE.0 .AND. GLOBAL_INDX(INT(2*GLOBAL_I)).NE.0) THEN
											SUB_K(GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)), GLOBAL_INDX(INT(2*GLOBAL_I))) = SUB_K(GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)), GLOBAL_INDX(INT(2*GLOBAL_I))) + DIFF_NN
										ENDIF
									ENDDO
								ENDIF
							ENDDO
	! 							CALL DR_FIND_GL_INDX_ALONG_INTERFACE_FII(GLOBAL_INDX(1:6), (/MASTER_PATCH, PATCH/), (/I,I/), INDX1)
							IF (GLOBAL_INDX(1).NE.0 .OR. GLOBAL_INDX(3).NE.0 .OR. GLOBAL_INDX(5).NE.0) THEN
								DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), EXACT_ON_BD(:)%X)
								DO GLOBAL_I = 1, 3
									IF (GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)).NE.0) THEN
										SUB_F(GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)))%X = SUB_F(GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)))%X + DIFF_NN
									ENDIF
								ENDDO
								DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), EXACT_ON_BD(:)%Y)
								DO GLOBAL_I = 1, 3
									IF (GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)).NE.0) THEN
										SUB_F(GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)))%Y = SUB_F(GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)))%Y + DIFF_NN
									ENDIF
								ENDDO
							ENDIF
						ENDDO
						
! 						PRINT*, 'BS-2', PATCH, JJ, SUB_K(TS_I,TS_J), SUB_F(TS_J)%Y
						
						!-----------------Compute elements on interface FIJ---------------------
						DO I = 1, UBOUND(INDX1,1)
							DO J = 1, UBOUND(INDX1,1)
								CALL DR_FIND_GL_INDX_ALONG_INTERFACE_FIJ(GLOBAL_INDX(1:2), (/MASTER_PATCH, PATCH/), (/I,J/), INDX1)
								IF (GLOBAL_INDX(1).EQ.0 .OR. GLOBAL_INDX(2).EQ.0) THEN
								ELSE
			! 								PRINT*, 'HERE 2', GLOBAL_INDX
									DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), SF1(:,J)%D00)
									SUB_K(GLOBAL_INDX(1), GLOBAL_INDX(2)) = SUB_K(GLOBAL_INDX(1), GLOBAL_INDX(2)) + DIFF_NN
									SUB_K(GLOBAL_INDX(2), GLOBAL_INDX(1)) = SUB_K(GLOBAL_INDX(2), GLOBAL_INDX(1)) + DIFF_NN
								ENDIF
							ENDDO
						ENDDO
						
! 						PRINT*, 'BS-3', PATCH, JJ, SUB_K(TS_I,TS_J), SUB_F(TS_J)%Y
						
					ENDDO
				ENDDO
			ENDIF
		ENDDO
		DEALLOCATE(SF1, INDX1)
	ENDDO
	DEALLOCATE(WEIGHT, EXACT_ON_BD)
	
! 	PRINT*, 'BS-4', PATCH, JJ, SUB_K(TS_I,TS_J), SUB_F(TS_J)%Y
			
	ALLOCATE(WEIGHT(NUMGSPT))
	ALLOCATE(EXACT_ON_BD(UBOUND(WEIGHT,1)))
	DO PATCH = 1, NUM_PATCH
		ALLOCATE(SF1(UBOUND(WEIGHT,1), (BASIS_KVEC(PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(PATCH,2)%POLY_ORDER+1)))
		ALLOCATE(INDX1((BASIS_KVEC(PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(PATCH,2)%POLY_ORDER+1)))
		DO JJ = 1, NUMIR(PATCH,1)-1
			IF (PATCH==1 .OR. PATCH==2) THEN		! TOP
			!----------------------- TOP SIDE ON THE PARAMETER SPACE ------------------------!
				DIFF_NN = 0.D0
				SUB_LN = VEC2D(POINT2D(IR_GRID(PATCH,1,JJ),1.D0), POINT2D(IR_GRID(PATCH,1,JJ+1),1.D0))
				CALL LEAST_SQUARE_LC_INT_II(SF1, INDX1, WEIGHT, EXACT_ON_BD, PATCH, SUB_LN, 'T')
				DO I=1, UBOUND(INDX1,1)
					DO J=1, UBOUND(INDX1,1)
						CALL DR_GL_INDX_FII(GLOBAL_INDX(1:2), PATCH, (/I,J/), INDX1)
						IF (GLOBAL_INDX(1).EQ.0 .OR. GLOBAL_INDX(2).EQ.0) THEN
						ELSE
							DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), SF1(:,J)%D00)
							SUB_K(GLOBAL_INDX(1), GLOBAL_INDX(2)) = SUB_K(GLOBAL_INDX(1), GLOBAL_INDX(2)) + DIFF_NN
						ENDIF
					ENDDO
					IF (GLOBAL_INDX(1).EQ.0) THEN
					ELSE
						DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), EXACT_ON_BD(:)%X)
						SUB_F(GLOBAL_INDX(1))%X = SUB_F(GLOBAL_INDX(1))%X + DIFF_NN
						DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), EXACT_ON_BD(:)%Y)
						SUB_F(GLOBAL_INDX(1))%Y = SUB_F(GLOBAL_INDX(1))%Y + DIFF_NN
					ENDIF
				ENDDO
				
! 				PRINT*, 'TP-1', PATCH, JJ, SUB_K(TS_I,TS_J), SUB_F(TS_J)%Y
				
				DO MASTER_PATCH = 1, PATCH-1
				!-----------------Compute elements on interface (i.e. FII)---------------------
					DO I = 1, UBOUND(INDX1,1)
						DO J = 1, UBOUND(INDX1,1)
							CALL DR_FIND_GL_INDX_ALONG_INTERFACE_FII(GLOBAL_INDX(1:6), (/MASTER_PATCH, PATCH/), (/I,J/), INDX1)
							IF ((GLOBAL_INDX(1).NE.0 .AND. GLOBAL_INDX(2).NE.0) .OR. &
									(GLOBAL_INDX(3).NE.0 .AND. GLOBAL_INDX(4).NE.0) .OR. &
									(GLOBAL_INDX(5).NE.0 .AND. GLOBAL_INDX(6).NE.0)) THEN
		! 					PRINT*, 'HERE 1', GLOBAL_INDX
								DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), SF1(:,J)%D00)
								DO GLOBAL_I = 1, 3
									IF (GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)).NE.0 .AND. GLOBAL_INDX(INT(2*GLOBAL_I)).NE.0) THEN
										SUB_K(GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)), GLOBAL_INDX(INT(2*GLOBAL_I))) = SUB_K(GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)), GLOBAL_INDX(INT(2*GLOBAL_I))) + DIFF_NN
									ENDIF
								ENDDO
							ENDIF
						ENDDO
! 							CALL DR_FIND_GL_INDX_ALONG_INTERFACE_FII(GLOBAL_INDX(1:6), (/MASTER_PATCH, PATCH/), (/I,I/), INDX1)
						IF (GLOBAL_INDX(1).NE.0 .OR. GLOBAL_INDX(3).NE.0 .OR. GLOBAL_INDX(5).NE.0) THEN
							DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), EXACT_ON_BD(:)%X)
							DO GLOBAL_I = 1, 3
								IF (GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)).NE.0) THEN
									SUB_F(GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)))%X = SUB_F(GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)))%X + DIFF_NN
								ENDIF
							ENDDO
							DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), EXACT_ON_BD(:)%Y)
							DO GLOBAL_I = 1, 3
								IF (GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)).NE.0) THEN
									SUB_F(GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)))%Y = SUB_F(GLOBAL_INDX(INT(2*(GLOBAL_I-1)+1)))%Y + DIFF_NN
								ENDIF
							ENDDO
						ENDIF
					ENDDO
					
! 					PRINT*, 'TP-2', PATCH, JJ, SUB_K(TS_I,TS_J), SUB_F(TS_J)%Y
					
					!-----------------Compute elements on interface FIJ---------------------
					DO I = 1, UBOUND(INDX1,1)
						DO J = 1, UBOUND(INDX1,1)
							CALL DR_FIND_GL_INDX_ALONG_INTERFACE_FIJ(GLOBAL_INDX(1:2), (/MASTER_PATCH, PATCH/), (/I,J/), INDX1)
							IF (GLOBAL_INDX(1).EQ.0 .OR. GLOBAL_INDX(2).EQ.0) THEN
							ELSE
		! 								PRINT*, 'HERE 2', GLOBAL_INDX
								DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), SF1(:,J)%D00)
								SUB_K(GLOBAL_INDX(1), GLOBAL_INDX(2)) = SUB_K(GLOBAL_INDX(1), GLOBAL_INDX(2)) + DIFF_NN
								SUB_K(GLOBAL_INDX(2), GLOBAL_INDX(1)) = SUB_K(GLOBAL_INDX(2), GLOBAL_INDX(1)) + DIFF_NN
							ENDIF
						ENDDO
					ENDDO
					
! 					PRINT*, 'TP-3', PATCH, JJ, SUB_K(TS_I,TS_J), SUB_F(TS_J)%Y
					
				ENDDO
! 				PRINT*, 'TP', PATCH, JJ, SUB_K(22,19)
			ENDIF
		ENDDO
		DEALLOCATE(SF1, INDX1)
	ENDDO
	DEALLOCATE(WEIGHT, EXACT_ON_BD)
	
! 	PRINT*, 'TP-4', PATCH, JJ, SUB_K(TS_I,TS_J), SUB_F(TS_J)%Y
	
	!----------------------- INTERSECTION LINE BETWEEN IGA AND EGM ------------------------!
	IGA_PATCH = 3
	EGM_PATCH = 4
	
	ALLOCATE(WEIGHT(XIGA_NUMGSPT))
	ALLOCATE(SF1(UBOUND(WEIGHT,1), (BASIS_KVEC(IGA_PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(IGA_PATCH,2)%POLY_ORDER+1)))
	ALLOCATE(INDX1((BASIS_KVEC(IGA_PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(IGA_PATCH,2)%POLY_ORDER+1)))
	
	ALLOCATE(SF2(UBOUND(WEIGHT,1), (BASIS_KVEC(EGM_PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(EGM_PATCH,2)%POLY_ORDER+1)))
	ALLOCATE(INDX2((BASIS_KVEC(EGM_PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(EGM_PATCH,2)%POLY_ORDER+1)))
	
	DO IGA_I = 1, NUMIR(IGA_PATCH,2)-1
		SUPP_IGA = VEC2D(POINT2D(1.D0, IR_GRID(IGA_PATCH,2,IGA_I)), POINT2D(1.D0, IR_GRID(IGA_PATCH,2,IGA_I+1)))
		DO JJ = 1, NUMIR(EGM_PATCH,2)-1
			SUB_LN_LENGTH = DABS(IR_GRID(EGM_PATCH,2,JJ+1) - IR_GRID(EGM_PATCH,2,JJ))/(1.D0*NUM_LN)
			!----------------------- LEFT SIDE ON THE PARAMETER SPACE ------------------------!
			DO II=1, NUM_LN
				SUB_LN = VEC2D(POINT2D(0.D0,IR_GRID(EGM_PATCH,2,JJ)+(II-1)*SUB_LN_LENGTH), POINT2D(0.D0,IR_GRID(EGM_PATCH,2,JJ)+II*SUB_LN_LENGTH))
				DIFF_NN = 0.D0
				CALL LEAST_SQUARE_LC_INT_IJ(SF1, SF2, INDX1, INDX2, WEIGHT, (/IGA_PATCH, EGM_PATCH/), SUB_LN, SUPP_IGA, 'L')
				DO I=1, UBOUND(INDX1,1)
					DO J=1, UBOUND(INDX2,1)
						CALL DR_GL_INDX_FIJ(GLOBAL_INDX(1:2), (/IGA_PATCH, EGM_PATCH/), (/I, J/), INDX1, INDX2)
						IF (GLOBAL_INDX(1).EQ.0 .OR. GLOBAL_INDX(2).EQ.0) THEN
						ELSE
							DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), SF2(:,J)%D00)
							SUB_K(GLOBAL_INDX(1), GLOBAL_INDX(2)) = SUB_K(GLOBAL_INDX(1), GLOBAL_INDX(2)) + DIFF_NN
							SUB_K(GLOBAL_INDX(2), GLOBAL_INDX(1)) = SUB_K(GLOBAL_INDX(2), GLOBAL_INDX(1)) + DIFF_NN
						ENDIF
! 						PRINT*, 'IE-1-1', PATCH, JJ, SUB_K(TS_I,TS_J), SUB_F(TS_J)%Y
						CALL DR_FIND_GL_INDX_ALONG_INTERFACE_AND_EGM(GLOBAL_INDX(1:2), (/IGA_PATCH, EGM_PATCH/), (/I,J/), INDX1, INDX2)
						IF (GLOBAL_INDX(1).EQ.0 .OR. GLOBAL_INDX(2).EQ.0) THEN
						ELSE
	! 								PRINT*, 'HERE 2', GLOBAL_INDX
							DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), SF2(:,J)%D00)
							SUB_K(GLOBAL_INDX(1), GLOBAL_INDX(2)) = SUB_K(GLOBAL_INDX(1), GLOBAL_INDX(2)) + DIFF_NN
							SUB_K(GLOBAL_INDX(2), GLOBAL_INDX(1)) = SUB_K(GLOBAL_INDX(2), GLOBAL_INDX(1)) + DIFF_NN
						ENDIF
! 						PRINT*, 'IE-1-2', PATCH, JJ, SUB_K(TS_I,TS_J), SUB_F(TS_J)%Y
					ENDDO
				ENDDO
			ENDDO
		ENDDO
	ENDDO
	DEALLOCATE(SF1, SF2, INDX1, INDX2, WEIGHT)
	
! 	PRINT*, 'IE-1', PATCH, JJ, SUB_K(TS_I,TS_J), SUB_F(TS_J)%Y
	
	IGA_PATCH = 1
	EGM_PATCH = 4
	
	ALLOCATE(WEIGHT(XIGA_NUMGSPT))
	ALLOCATE(SF1(UBOUND(WEIGHT,1), (BASIS_KVEC(IGA_PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(IGA_PATCH,2)%POLY_ORDER+1)))
	ALLOCATE(INDX1((BASIS_KVEC(IGA_PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(IGA_PATCH,2)%POLY_ORDER+1)))
	
	ALLOCATE(SF2(UBOUND(WEIGHT,1), (BASIS_KVEC(EGM_PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(EGM_PATCH,2)%POLY_ORDER+1)))
	ALLOCATE(INDX2((BASIS_KVEC(EGM_PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(EGM_PATCH,2)%POLY_ORDER+1)))
	
	DO IGA_I = 1, NUMIR(IGA_PATCH,1)-1
		SUPP_IGA = VEC2D(POINT2D(IR_GRID(IGA_PATCH,1,IGA_I),0.D0), POINT2D(IR_GRID(IGA_PATCH,1,IGA_I+1),0.D0))
		DO JJ = 1, NUMIR(EGM_PATCH,2)-1
			SUB_LN_LENGTH = DABS(IR_GRID(EGM_PATCH,2,JJ+1) - IR_GRID(EGM_PATCH,2,JJ))/(1.D0*NUM_LN)
			!----------------------- RIGHT SIDE ON THE PARAMETER SPACE ------------------------!
			DO II=1, NUM_LN
				SUB_LN = VEC2D(POINT2D(1.D0,IR_GRID(EGM_PATCH,2,JJ)+(II-1)*SUB_LN_LENGTH), POINT2D(1.D0,IR_GRID(EGM_PATCH,2,JJ)+II*SUB_LN_LENGTH))
				DIFF_NN = 0.D0
	! 			PRINT*, 'RM', JJ, II, IGA_PATCH, EGM_PATCH
				CALL LEAST_SQUARE_LC_INT_IJ(SF1, SF2, INDX1, INDX2, WEIGHT, (/IGA_PATCH,EGM_PATCH/), SUB_LN, SUPP_IGA, 'R')
				DO I=1, UBOUND(INDX1,1)
					DO J=1, UBOUND(INDX2,1)
						CALL DR_GL_INDX_FIJ(GLOBAL_INDX(1:2), (/IGA_PATCH, EGM_PATCH/), (/I, J/), INDX1, INDX2)
						IF (GLOBAL_INDX(1).EQ.0 .OR. GLOBAL_INDX(2).EQ.0) THEN
						ELSE
							DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), SF2(:,J)%D00)
							SUB_K(GLOBAL_INDX(1), GLOBAL_INDX(2)) = SUB_K(GLOBAL_INDX(1), GLOBAL_INDX(2)) + DIFF_NN
							SUB_K(GLOBAL_INDX(2), GLOBAL_INDX(1)) = SUB_K(GLOBAL_INDX(2), GLOBAL_INDX(1)) + DIFF_NN
						ENDIF
						CALL DR_FIND_GL_INDX_ALONG_INTERFACE_AND_EGM(GLOBAL_INDX(1:2), (/IGA_PATCH, EGM_PATCH/), (/I,J/), INDX1, INDX2)
						IF (GLOBAL_INDX(1).EQ.0 .OR. GLOBAL_INDX(2).EQ.0) THEN
						ELSE
	! 								PRINT*, 'HERE 2', GLOBAL_INDX
							DIFF_NN = DOT_PRODUCT(PRODUCT(RESHAPE((/SF1(:,I)%D00, WEIGHT(:)/), (/UBOUND(WEIGHT,1), 2/), ORDER=ORDER1), 2), SF2(:,J)%D00)
							SUB_K(GLOBAL_INDX(1), GLOBAL_INDX(2)) = SUB_K(GLOBAL_INDX(1), GLOBAL_INDX(2)) + DIFF_NN
							SUB_K(GLOBAL_INDX(2), GLOBAL_INDX(1)) = SUB_K(GLOBAL_INDX(2), GLOBAL_INDX(1)) + DIFF_NN
						ENDIF
					ENDDO
				ENDDO
			ENDDO
		ENDDO
	ENDDO
	
! 	PRINT*, 'IE-2', PATCH, JJ, SUB_K(TS_I,TS_J), SUB_F(TS_J)%Y
	
	DEALLOCATE(SF1, SF2, INDX1, INDX2, WEIGHT)
	
END SUBROUTINE GEN_BD_LN

!! Compute line integration on Neumann boundary
SUBROUTINE IMPOSE_NEUMANN_BD(STIF_F)

	REAL*8, INTENT(INOUT) :: STIF_F(2*DOF)
	
	INTEGER :: I, J
	TYPE(POINT2D) :: LN_INT

	DO J=1, NM_NUMBD
		DO I=1, NM_BDNDX(J,1)%LC_NUM
			CALL NEUMANN_LN_INT(LN_INT, NM_BDNDX(J,I), J)
! 			print*, j, i, nm_bdndx(j,i)%patch_ndx, nm_bdndx(j,i)%lc_ndx
! 			IF (NM_BDNDX(J,I)%GL_NDX==2) THEN
! 				PRINT*, NM_BDNDX(J,I)%GL_NDX, LN_INT
! 			ENDIF
			STIF_F(NM_BDNDX(J,I)%GL_NDX) = STIF_F(NM_BDNDX(J,I)%GL_NDX) + LN_INT%X
			STIF_F(DOF + NM_BDNDX(J,I)%GL_NDX) = STIF_F(DOF + NM_BDNDX(J,I)%GL_NDX) + LN_INT%Y
		ENDDO
	ENDDO

END SUBROUTINE IMPOSE_NEUMANN_BD

!! Compute line integration on Neumann boundary
SUBROUTINE NEUMANN_LN_INT(LN_INT, NM_INFO, GAMMA)

	TYPE(POINT2D), INTENT(OUT) :: LN_INT
	TYPE(BD_INFO), INTENT(IN) :: NM_INFO
	INTEGER, INTENT(IN) :: GAMMA
	
	TYPE(MATRIX_22) :: JACOB
	TYPE(FVALUE) :: DIFF_NURBS
	TYPE(POINT2D) :: GSPT, TRC(1)
	REAL*8 :: DET_M, GS(NUMGSPT), GSW(NUMGSPT)
	INTEGER :: I, J, K, II, JJ, KK, IX, IY, PATCH
	
	LN_INT = POINT2D(0.D0, 0.D0)
	
	PATCH = NM_INFO%PATCH_NDX
	
	IX = NM_INFO%LC_NDX(1)
	IY = NM_INFO%LC_NDX(2)
	
	IF  (GAMMA==1 .OR. GAMMA==5) THEN
		DO II = 1, NUMIR(PATCH, 1)-1
			CALL GAULEG(IR_GRID(PATCH, 1, II), IR_GRID(PATCH, 1, II+1), GS, GSW, NUMGSPT)
			DO I = 1, NUMGSPT
				GSPT = POINT2D(GS(I),1.D0)
				
				DET_M = GET_DET_LN(GSPT, GAMMA, PATCH)
! 				print*, 'here1'
				JACOB = GET_JACOBIAN_MATRIX(GSPT, PATCH)
! 				print*, 'here2'
				DIFF_NURBS = GET_PHY_NURBS_SURFACE_2D(GSPT, IX, IY, JACOB, PATCH)
! 				print*, 'here3'
				CALL TRACTION(TRC, (/GSPT/), PATCH, GAMMA)
! 				print*, 'here4'
				LN_INT%X = LN_INT%X + DIFF_NURBS%D00*TRC(1)%X*DET_M*GSW(I)
				LN_INT%Y = LN_INT%Y + DIFF_NURBS%D00*TRC(1)%Y*DET_M*GSW(I)
			ENDDO
		ENDDO
! 		IF (NM_INFO%GL_NDX==2) THEN
! 			PRINT*, 'LN_INT-1', LN_INT
! 		ENDIF
	ELSEIF (GAMMA==3 .OR. GAMMA==7) THEN
		DO II = 1, NUMIR(PATCH, 1)-1
			CALL GAULEG(IR_GRID(PATCH, 1, II), IR_GRID(PATCH, 1, II+1), GS, GSW, NUMGSPT)
			DO I = 1, NUMGSPT
				GSPT = POINT2D(GS(I),0.D0)
				
				DET_M = GET_DET_LN(GSPT, GAMMA, PATCH)
		
				JACOB = GET_JACOBIAN_MATRIX(GSPT,PATCH)
		
				DIFF_NURBS = GET_PHY_NURBS_SURFACE_2D(GSPT, IX, IY, JACOB, PATCH)
		
				CALL TRACTION(TRC, (/GSPT/), PATCH, GAMMA)
		
				LN_INT%X = LN_INT%X + DIFF_NURBS%D00*TRC(1)%X*DET_M*GSW(I)
				LN_INT%Y = LN_INT%Y + DIFF_NURBS%D00*TRC(1)%Y*DET_M*GSW(I)
				
! 				IF (NM_INFO%GL_NDX==2) THEN
! 					PRINT*, 'GSPT', GSPT
! 					PRINT*, 'DET_M', DET_M
! 					PRINT*, 'DIFF_NURBS', DIFF_NURBS%D00
! 					PRINT*, 'TRC', TRC(1)
! 					PRINT*, 'GSW', GSW(I)
! 					PRINT*, 'LN_INT', LN_INT
! 					PRINT*, '------------------------------------------------'
! 				ENDIF
			ENDDO
		ENDDO
		
! 		IF (NM_INFO%GL_NDX==2) THEN
! 			PRINT*, 'LN_INT-2', LN_INT
! 		ENDIF
		
	ELSEIF (GAMMA==2 .OR. GAMMA==6) THEN
		DO II = 1, NUMIR(PATCH, 2)-1
			CALL GAULEG(IR_GRID(PATCH, 2, II), IR_GRID(PATCH, 2, II+1), GS, GSW, NUMGSPT)
			DO I = 1, NUMGSPT
				GSPT = POINT2D(0.D0, GS(I))
				
				DET_M = GET_DET_LN(GSPT, GAMMA, PATCH)
		
				JACOB = GET_JACOBIAN_MATRIX(GSPT,PATCH)
		
				DIFF_NURBS = GET_PHY_NURBS_SURFACE_2D(GSPT, IX, IY, JACOB, PATCH)
		
				CALL TRACTION(TRC, (/GSPT/), PATCH, GAMMA)
		
				LN_INT%X = LN_INT%X + DIFF_NURBS%D00*TRC(1)%X*DET_M*GSW(I)
				LN_INT%Y = LN_INT%Y + DIFF_NURBS%D00*TRC(1)%Y*DET_M*GSW(I)
			ENDDO
		ENDDO
! 		IF (NM_INFO%GL_NDX==2) THEN
! 			PRINT*, 'LN_INT-3', LN_INT
! 		ENDIF
	ELSEIF (GAMMA==4) THEN
		DO II = 1, NUMIR(PATCH, 2)-1
			CALL GAULEG(IR_GRID(PATCH, 2, II), IR_GRID(PATCH, 2, II+1), GS, GSW, NUMGSPT)
			DO I = 1, NUMGSPT
				GSPT = POINT2D(1.D0, GS(I))
				
				DET_M = GET_DET_LN(GSPT, GAMMA, PATCH)
		
				JACOB = GET_JACOBIAN_MATRIX(GSPT,PATCH)
		
				DIFF_NURBS = GET_PHY_NURBS_SURFACE_2D(GSPT, IX, IY, JACOB, PATCH)
		
				CALL TRACTION(TRC, (/GSPT/), PATCH, GAMMA)
		
				LN_INT%X = LN_INT%X + DIFF_NURBS%D00*TRC(1)%X*DET_M*GSW(I)
				LN_INT%Y = LN_INT%Y + DIFF_NURBS%D00*TRC(1)%Y*DET_M*GSW(I)
			ENDDO
		ENDDO
! 		IF (NM_INFO%GL_NDX==2) THEN
! 			PRINT*, 'LN_INT-4', LN_INT
! 		ENDIF
	ENDIF
! 		IF (NM_INFO%GL_NDX==2) THEN
! 			PRINT*, 'LN_INT-5', LN_INT
! 		ENDIF
	!! Compute line integration of NURBS basis functions on interface
	IF (NM_INFO%INTERFACE_LG) THEN
		IF (NM_INFO%SLAVE_GAMMA==3) THEN
			DO II = 1, NUMIR(NM_INFO%SLAVE_PATCH_NDX, 1)-1
				CALL GAULEG(IR_GRID(NM_INFO%SLAVE_PATCH_NDX, 1, II), IR_GRID(NM_INFO%SLAVE_PATCH_NDX, 1, II+1), GS, GSW, NUMGSPT)
				DO I = 1, NUMGSPT
					GSPT = POINT2D(GS(I), 0.D0)
					
					DET_M = GET_DET_LN(GSPT, NM_INFO%SLAVE_GAMMA, NM_INFO%SLAVE_PATCH_NDX)
			
					JACOB = GET_JACOBIAN_MATRIX(GSPT, NM_INFO%SLAVE_PATCH_NDX)
			
					DIFF_NURBS = GET_PHY_NURBS_SURFACE_2D(GSPT, NM_INFO%LC_INTERFACE_NDX(1), NM_INFO%LC_INTERFACE_NDX(2), JACOB, NM_INFO%SLAVE_PATCH_NDX)
			
					CALL TRACTION(TRC, (/GSPT/), NM_INFO%SLAVE_PATCH_NDX, NM_INFO%SLAVE_GAMMA)
			
					LN_INT%X = LN_INT%X + DIFF_NURBS%D00*TRC(1)%X*DET_M*GSW(I)
					LN_INT%Y = LN_INT%Y + DIFF_NURBS%D00*TRC(1)%Y*DET_M*GSW(I)
				ENDDO
			ENDDO
! 			IF (NM_INFO%GL_NDX==2) THEN
! 				PRINT*, 'LN_INT-6', LN_INT
! 			ENDIF
		ELSEIF (NM_INFO%SLAVE_GAMMA==4) THEN
			DO II = 1, NUMIR(NM_INFO%SLAVE_PATCH_NDX, 2)-1
				CALL GAULEG(IR_GRID(NM_INFO%SLAVE_PATCH_NDX, 2, II), IR_GRID(NM_INFO%SLAVE_PATCH_NDX, 2, II+1), GS, GSW, NUMGSPT)
				DO I = 1, NUMGSPT
					GSPT = POINT2D(1.D0, GS(I))
					
					DET_M = GET_DET_LN(GSPT, NM_INFO%SLAVE_GAMMA, NM_INFO%SLAVE_PATCH_NDX)
			
					JACOB = GET_JACOBIAN_MATRIX(GSPT, NM_INFO%SLAVE_PATCH_NDX)
			
					DIFF_NURBS = GET_PHY_NURBS_SURFACE_2D(GSPT, NM_INFO%LC_INTERFACE_NDX(1), NM_INFO%LC_INTERFACE_NDX(2), JACOB, NM_INFO%SLAVE_PATCH_NDX)
			
					CALL TRACTION(TRC, (/GSPT/), NM_INFO%SLAVE_PATCH_NDX, NM_INFO%SLAVE_GAMMA)
			
					LN_INT%X = LN_INT%X + DIFF_NURBS%D00*TRC(1)%X*DET_M*GSW(I)
					LN_INT%Y = LN_INT%Y + DIFF_NURBS%D00*TRC(1)%Y*DET_M*GSW(I)
				ENDDO
			ENDDO
! 			IF (NM_INFO%GL_NDX==2) THEN
! 				PRINT*, 'LN_INT-7', LN_INT
! 			ENDIF
		ELSEIF (NM_INFO%SLAVE_GAMMA==5) THEN
			DO II = 1, NUMIR(NM_INFO%SLAVE_PATCH_NDX, 1)-1
				CALL GAULEG(IR_GRID(NM_INFO%SLAVE_PATCH_NDX, 1, II), IR_GRID(NM_INFO%SLAVE_PATCH_NDX, 1, II+1), GS, GSW, NUMGSPT)
				DO I = 1, NUMGSPT
					GSPT = POINT2D(GS(I), 1.D0)
					
					DET_M = GET_DET_LN(GSPT, NM_INFO%SLAVE_GAMMA, NM_INFO%SLAVE_PATCH_NDX)
			
					JACOB = GET_JACOBIAN_MATRIX(GSPT, NM_INFO%SLAVE_PATCH_NDX)
			
					DIFF_NURBS = GET_PHY_NURBS_SURFACE_2D(GSPT, NM_INFO%LC_INTERFACE_NDX(1), NM_INFO%LC_INTERFACE_NDX(2), JACOB, NM_INFO%SLAVE_PATCH_NDX)
			
					CALL TRACTION(TRC, (/GSPT/), NM_INFO%SLAVE_PATCH_NDX, NM_INFO%SLAVE_GAMMA)
			
					LN_INT%X = LN_INT%X + DIFF_NURBS%D00*TRC(1)%X*DET_M*GSW(I)
					LN_INT%Y = LN_INT%Y + DIFF_NURBS%D00*TRC(1)%Y*DET_M*GSW(I)
				ENDDO
			ENDDO
! 			IF (NM_INFO%GL_NDX==2) THEN
! 				PRINT*, 'LN_INT-8', LN_INT
! 			ENDIF
		ELSEIF (NM_INFO%SLAVE_GAMMA==7) THEN
			DO II = 1, NUMIR(NM_INFO%SLAVE_PATCH_NDX, 1)-1
				CALL GAULEG(IR_GRID(NM_INFO%SLAVE_PATCH_NDX, 1, II), IR_GRID(NM_INFO%SLAVE_PATCH_NDX, 1, II+1), GS, GSW, NUMGSPT)
				DO I = 1, NUMGSPT
					GSPT = POINT2D(GS(I), 0.D0)
					
					DET_M = GET_DET_LN(GSPT, NM_INFO%SLAVE_GAMMA, NM_INFO%SLAVE_PATCH_NDX)
			
					JACOB = GET_JACOBIAN_MATRIX(GSPT, NM_INFO%SLAVE_PATCH_NDX)
			
					DIFF_NURBS = GET_PHY_NURBS_SURFACE_2D(GSPT, NM_INFO%LC_INTERFACE_NDX(1), NM_INFO%LC_INTERFACE_NDX(2), JACOB, NM_INFO%SLAVE_PATCH_NDX)
			
					CALL TRACTION(TRC, (/GSPT/), NM_INFO%SLAVE_PATCH_NDX, NM_INFO%SLAVE_GAMMA)
			
					LN_INT%X = LN_INT%X + DIFF_NURBS%D00*TRC(1)%X*DET_M*GSW(I)
					LN_INT%Y = LN_INT%Y + DIFF_NURBS%D00*TRC(1)%Y*DET_M*GSW(I)
				ENDDO
			ENDDO
! 			IF (NM_INFO%GL_NDX==2) THEN
! 				PRINT*, 'LN_INT-9', LN_INT
! 			ENDIF
		ELSE
			PRINT*, 'ERROR - NEUMANN_LN_INT : "NM_INFO%SLAVE_GAMMA" IS NOT SET COMPLETELY!'
			STOP
		ENDIF
	ENDIF
	
END SUBROUTINE NEUMANN_LN_INT

SUBROUTINE STIF_LC_INT_II(SF, WEIGHT, LOAD_F, INDX, PATCH, NUMIR_INDX)
	INTEGER, INTENT(IN) :: NUMIR_INDX(2), PATCH
	TYPE(FVALUE), INTENT(OUT) :: SF(NUMGSPT**2, (BASIS_KVEC(PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(PATCH,2)%POLY_ORDER+1))
	TYPE(INT2D), INTENT(OUT) :: INDX((BASIS_KVEC(PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(PATCH,2)%POLY_ORDER+1))
	REAL*8, INTENT(OUT) :: WEIGHT(NUMGSPT**2)
	TYPE(POINT2D), INTENT(OUT) :: LOAD_F(NUMGSPT**2)
	
	TYPE(RECPATCH) :: IRBOX
	TYPE(POINT2D) :: GSPT, DMY_GSPT
	TYPE(MATRIX_22) :: JACOB
	INTEGER :: I,J, K, II, JJ, KK
	REAL*8 :: DET_M

	SF(:,:) = FVALUE(0.D0,0.D0,0.D0,0.D0,0.D0,0.D0)
	INDX(:) = INT2D(-1,-1)
	WEIGHT(:) = 0.D0
	LOAD_F(:) = POINT2D(0.D0, 0.D0)

	IRBOX%PT1 = POINT2D(IR_GRID(PATCH,1,NUMIR_INDX(1)), IR_GRID(PATCH,2,NUMIR_INDX(2)))
	IRBOX%PT2 = POINT2D(IR_GRID(PATCH,1,NUMIR_INDX(1)+1), IR_GRID(PATCH,2,NUMIR_INDX(2)))
	IRBOX%PT3 = POINT2D(IR_GRID(PATCH,1,NUMIR_INDX(1)+1), IR_GRID(PATCH,2,NUMIR_INDX(2)+1))
	IRBOX%PT4 = POINT2D(IR_GRID(PATCH,1,NUMIR_INDX(1)), IR_GRID(PATCH,2,NUMIR_INDX(2)+1))

	!------------------! VECTORIZE GAUSS POINTS AND WEIGHTS------------------------------
	CALL GAULEG(IRBOX%PT1%X, IRBOX%PT2%X, GSX, GSXW, NUMGSPT)
	CALL GAULEG(IRBOX%PT1%Y, IRBOX%PT4%Y, GSY, GSYW, NUMGSPT)
	
	KK=0
	DO I=1,NUMGSPT
		DO J=1,NUMGSPT
! 			PRINT*, I, J
			KK=KK+1
			GSPT = POINT2D(GSX(I), GSY(J))
			DMY_GSPT = GSPT
			JACOB = GET_JACOBIAN_MATRIX(GSPT,PATCH)
			DET_M = .DETERMINANT.JACOB
! 			PRINT*, DET_M
			WEIGHT(KK) = DET_M*GSXW(I)*GSYW(J)
! 			PRINT*, WEIGHT(KK)
			LOAD_F(KK) = LDFT2D(GSPT,PATCH)
			IF (PATCH.LE.NUM_IGA_PATCH) THEN
				CALL GET_ALL_PHY_NURBS_SURFACE_2D(SF(KK,:), INDX(:), DMY_GSPT, JACOB, PATCH)
			ELSE
				CALL GET_ALL_PHY_BASIS_IN_INT(SF(KK,:), INDX(:), DMY_GSPT, JACOB, PATCH)
			ENDIF
		ENDDO
	ENDDO
	
! 	PRINT*, 'STIF_LC_INT_II - DONE'
	
END SUBROUTINE STIF_LC_INT_II

SUBROUTINE STIF_LC_INT_IJ(SF1, SF2, INDX1, INDX2, WEIGHT, PATCHES, LOWER_LIMIT, UPPER_LIMIT, SUPP_G)

	INTEGER, INTENT(IN) :: PATCHES(2) ! PATCHES(1) = IGA_PATCH,	PATCHES(2) = EGM_PATCH
	TYPE(POINT2D), INTENT(IN) :: LOWER_LIMIT, UPPER_LIMIT
	TYPE(RECPATCH), INTENT(IN) :: SUPP_G
	
	TYPE(FVALUE), INTENT(OUT) :: SF1(XIGA_NUMGSPT**2, (BASIS_KVEC(PATCHES(1),1)%POLY_ORDER+1)*(BASIS_KVEC(PATCHES(1),2)%POLY_ORDER+1))
	TYPE(FVALUE), INTENT(OUT) :: SF2(XIGA_NUMGSPT**2, (BASIS_KVEC(PATCHES(2),1)%POLY_ORDER+1)*(BASIS_KVEC(PATCHES(2),2)%POLY_ORDER+1))
	TYPE(INT2D), INTENT(OUT) :: INDX1((BASIS_KVEC(PATCHES(1),1)%POLY_ORDER+1)*(BASIS_KVEC(PATCHES(1),2)%POLY_ORDER+1))
	TYPE(INT2D), INTENT(OUT) :: INDX2((BASIS_KVEC(PATCHES(2),1)%POLY_ORDER+1)*(BASIS_KVEC(PATCHES(2),2)%POLY_ORDER+1))
	REAL*8, INTENT(OUT) :: WEIGHT(XIGA_NUMGSPT**2)
	
	TYPE(RECPATCH) :: IRBOX
	TYPE(POINT2D) :: GSPT, DMY_GSPT, PHYPT_F, INV_PHYPT_G
	TYPE(MATRIX_22) :: JACOB_F, JACOB_G
	INTEGER :: I,J, K, II, JJ, KK, IGA_PATCH
	REAL*8 :: DET_JF
	LOGICAL :: PT_IN_SUPP
	
	SF1(:,:) = FVALUE(0.D0,0.D0,0.D0,0.D0,0.D0,0.D0)
	SF2(:,:) = FVALUE(0.D0,0.D0,0.D0,0.D0,0.D0,0.D0)
	INDX1(:) = INT2D(-1,-1)
	INDX2(:) = INT2D(-1,-1)
	WEIGHT(:) = 0.D0
	
	!------------------! VECTORIZE GAUSS POINTS AND WEIGHTS------------------------------
	CALL GAULEG(LOWER_LIMIT%X, UPPER_LIMIT%X, XIGA_GSX, XIGA_GSXW, XIGA_NUMGSPT)
	CALL GAULEG(LOWER_LIMIT%Y, UPPER_LIMIT%Y, XIGA_GSY, XIGA_GSYW, XIGA_NUMGSPT)
	
	KK=0
	DO I=1,XIGA_NUMGSPT
		DO J=1,XIGA_NUMGSPT
			KK=KK+1
! 			PRINT*, I, J
			GSPT = POINT2D(XIGA_GSX(I), XIGA_GSY(J))
			DMY_GSPT = GSPT
			PHYPT_F = GET_PHY_PT(DMY_GSPT,PATCHES(2))
! 			PRINT*, PHYPT_F
			IGA_PATCH = GET_IGA_PATCH_INDX(PHYPT_F)
			
			IF (IGA_PATCH==PATCHES(1)) THEN
				INV_PHYPT_G = GET_REF_PT(PHYPT_F,PATCHES(1))
				PT_IN_SUPP = BELONGTO_R(INV_PHYPT_G, SUPP_G)
! 			PRINT*, INV_PHYPT_G
				
				IF (PT_IN_SUPP.EQV..TRUE.) THEN
					JACOB_F = GET_JACOBIAN_MATRIX(DMY_GSPT,PATCHES(2))
					JACOB_G = GET_JACOBIAN_MATRIX(INV_PHYPT_G,PATCHES(1))
					
					DET_JF = .DETERMINANT.JACOB_F
					WEIGHT(KK) = DET_JF*XIGA_GSXW(I)*XIGA_GSYW(J)
		! 			PRINT*, 'STIF_LC_INT_IN - HERE0'
					CALL GET_ALL_PHY_NURBS_SURFACE_2D(SF1(KK,:), INDX1(:), INV_PHYPT_G, JACOB_G, PATCHES(1))
		! 			PRINT*, 'STIF_LC_INT_IN - HERE1'
					CALL GET_ALL_PHY_BASIS_IN_INT(SF2(KK,:), INDX2(:), DMY_GSPT, JACOB_F, PATCHES(2))
		! 			PRINT*, 'STIF_LC_INT_IN - HERE2'
				ELSE
					GOTO 10
				ENDIF
			ENDIF
			10 CONTINUE
		ENDDO
	ENDDO
	
	
! 	PRINT*, 'STIF_LC_INT_IJ - DONE'
	
END SUBROUTINE STIF_LC_INT_IJ

SUBROUTINE STIF_FIND_GLOBAL_INDX_FII(GLOBAL_INDX, PATCH, LOCAL_INDX, INDX)
	INTEGER, INTENT(IN) :: PATCH, LOCAL_INDX(2)
	TYPE(INT2D), INTENT(IN) :: INDX((BASIS_KVEC(PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(PATCH,2)%POLY_ORDER+1))
	INTEGER, INTENT(OUT) :: GLOBAL_INDX(2)
	
	INTEGER :: I, J, K, II, JJ, KK, LOCAL_DOF_SUM
	
	IF (PATCH.EQ.1) THEN
		LOCAL_DOF_SUM = 0
	ELSE
		LOCAL_DOF_SUM = SUM(LOCAL_DOF(1:PATCH-1))
	ENDIF

	DO I = 1, 2
		DO KK=1, LOCAL_DOF(PATCH)
			IF (NDX(1,LOCAL_DOF_SUM + KK).EQ.INDX(LOCAL_INDX(I))%A .AND. NDX(2,LOCAL_DOF_SUM + KK).EQ.INDX(LOCAL_INDX(I))%B) THEN
				GLOBAL_INDX(I) = LOCAL_DOF_SUM + KK
				GOTO 10
			ELSE
				GLOBAL_INDX(I) = 0
			ENDIF
		ENDDO
		10 CONTINUE
	ENDDO
	
END SUBROUTINE STIF_FIND_GLOBAL_INDX_FII

SUBROUTINE STIF_FIND_GLOBAL_INDX_FIJ(GLOBAL_INDX, PATCHES, LOCAL_INDX, INDX1, INDX2)
	INTEGER, INTENT(IN) :: PATCHES(2), LOCAL_INDX(2) ! PATCHES(1) = IGA PATCH,  PATCHES(2) = EGM PATCH
	TYPE(INT2D), INTENT(IN) :: INDX1((BASIS_KVEC(PATCHES(1),1)%POLY_ORDER+1)*(BASIS_KVEC(PATCHES(1),2)%POLY_ORDER+1))
	TYPE(INT2D), INTENT(IN) :: INDX2((BASIS_KVEC(PATCHES(2),1)%POLY_ORDER+1)*(BASIS_KVEC(PATCHES(2),2)%POLY_ORDER+1))
	INTEGER, INTENT(OUT) :: GLOBAL_INDX(2)
	
	INTEGER :: I, J, K, II, JJ, KK, LOCAL_DOF_SUM(2)
	
	DO I = 1, 2
		IF (PATCHES(I).EQ.1) THEN
			LOCAL_DOF_SUM(I) = 0
		ELSE
			LOCAL_DOF_SUM(I) = SUM(LOCAL_DOF(1:PATCHES(I)-1))
		ENDIF
	ENDDO
	
	GLOBAL_INDX(:) = 0
	
	DO KK=1, LOCAL_DOF(PATCHES(1))
		IF (NDX(1,LOCAL_DOF_SUM(1) + KK).EQ.INDX1(LOCAL_INDX(1))%A .AND. NDX(2,LOCAL_DOF_SUM(1) + KK).EQ.INDX1(LOCAL_INDX(1))%B) THEN
			GLOBAL_INDX(1) = LOCAL_DOF_SUM(1) + KK
			GOTO 10
		ELSE
			GLOBAL_INDX(1) = 0
		ENDIF
	ENDDO
	10 CONTINUE

	DO KK=1, LOCAL_DOF(PATCHES(2))
		IF (NDX(1,LOCAL_DOF_SUM(2) + KK).EQ.INDX2(LOCAL_INDX(2))%A .AND. NDX(2,LOCAL_DOF_SUM(2) + KK).EQ.INDX2(LOCAL_INDX(2))%B) THEN
			GLOBAL_INDX(2) = LOCAL_DOF_SUM(2) + KK
			GOTO 20
		ELSE
			GLOBAL_INDX(2) = 0
		ENDIF
	ENDDO
	20 CONTINUE
	
END SUBROUTINE STIF_FIND_GLOBAL_INDX_FIJ

SUBROUTINE STIF_FIND_GLOBAL_INDX_ALONG_INTERFACE_FII(GLOBAL_INDX, PATCH, LOCAL_INDX, INDX)
	INTEGER, INTENT(OUT) :: GLOBAL_INDX(6)
	INTEGER, INTENT(IN) :: PATCH(2), LOCAL_INDX(2)	! PATCH(1) = MASTER_PATCH, PATCH(2) = SLAVE_PATCH
	TYPE(INT2D), INTENT(IN) :: INDX((BASIS_KVEC(PATCH(2),1)%POLY_ORDER+1)*(BASIS_KVEC(PATCH(2),2)%POLY_ORDER+1))
	
	INTEGER :: I, J, K, II, JJ, KK, GL_INDX_TO_SLAVE_PATCH_NDX(6)
	
	GLOBAL_INDX(:) = 0
	GL_INDX_TO_SLAVE_PATCH_NDX = (/1, 1, 2, 2, 3, 3/)
	
	DO I = 1, UBOUND(GLOBAL_INDX,1)
		IF (MOD(I,2)==0) THEN
			DO KK=1, UBOUND(INTERFACE_NDX,1)
				IF (INTERFACE_NDX(KK)%MASTER_PATCH_NDX.EQ.PATCH(1) .AND. INTERFACE_NDX(KK)%SLAVE_PATCH_NDX(GL_INDX_TO_SLAVE_PATCH_NDX(I)).EQ.PATCH(2) .AND. &
						INTERFACE_NDX(KK)%LC_NDX(I+1).EQ.INDX(LOCAL_INDX(2))%A .AND. INTERFACE_NDX(KK)%LC_NDX(I+2).EQ.INDX(LOCAL_INDX(2))%B) THEN
					GLOBAL_INDX(I) = INTERFACE_NDX(KK)%GL_NDX
					GOTO 10
				ELSE
				GLOBAL_INDX(I) = 0
				ENDIF
			ENDDO
		ELSE
			DO KK=1, UBOUND(INTERFACE_NDX,1)
				IF (INTERFACE_NDX(KK)%MASTER_PATCH_NDX.EQ.PATCH(1) .AND. INTERFACE_NDX(KK)%SLAVE_PATCH_NDX(GL_INDX_TO_SLAVE_PATCH_NDX(I)).EQ.PATCH(2) .AND. &
						INTERFACE_NDX(KK)%LC_NDX(I+2).EQ.INDX(LOCAL_INDX(1))%A .AND. INTERFACE_NDX(KK)%LC_NDX(I+3).EQ.INDX(LOCAL_INDX(1))%B) THEN
					GLOBAL_INDX(I) = INTERFACE_NDX(KK)%GL_NDX
					GOTO 20
				ELSE
					GLOBAL_INDX(I) = 0
				ENDIF
			ENDDO
		ENDIF
		10 CONTINUE
		20 CONTINUE
	ENDDO

END SUBROUTINE STIF_FIND_GLOBAL_INDX_ALONG_INTERFACE_FII

SUBROUTINE STIF_FIND_GLOBAL_INDX_ALONG_INTERFACE_FIJ(GLOBAL_INDX, PATCH, LOCAL_INDX, INDX)
	INTEGER, INTENT(OUT) :: GLOBAL_INDX(6)
	INTEGER, INTENT(IN) :: PATCH(2), LOCAL_INDX(2)	! PATCH(1) = MASTER_PATCH, PATCH(2) = SLAVE_PATCH
	TYPE(INT2D), INTENT(IN) :: INDX((BASIS_KVEC(PATCH(2),1)%POLY_ORDER+1)*(BASIS_KVEC(PATCH(2),2)%POLY_ORDER+1))
	
	INTEGER :: I, J, K, II, JJ, KK, GL_INDX_TO_SLAVE_PATCH_NDX(6)
	
	GLOBAL_INDX(:) = 0
	GL_INDX_TO_SLAVE_PATCH_NDX = (/1, 1, 2, 2, 3, 3/)
	
	DO KK=1, UBOUND(INTERFACE_NDX,1)
		IF (INTERFACE_NDX(KK)%MASTER_PATCH_NDX.EQ.PATCH(1) .AND. INTERFACE_NDX(KK)%SLAVE_PATCH_NDX(2).EQ.PATCH(2) .AND. &
				INTERFACE_NDX(KK)%LC_NDX(5).EQ.INDX(LOCAL_INDX(1))%A .AND. INTERFACE_NDX(KK)%LC_NDX(6).EQ.INDX(LOCAL_INDX(1))%B) THEN
			GLOBAL_INDX(1) = INTERFACE_NDX(KK)%GL_NDX
			GOTO 10
		ELSE
			GLOBAL_INDX(1) = 0
		ENDIF
	ENDDO
	10 CONTINUE

	IF (GLOBAL_INDX(1).EQ.0) THEN
		GLOBAL_INDX(2) = 0
	ELSE
		DO KK=1, UBOUND(INTERFACE_NDX,1)
			IF (INTERFACE_NDX(KK)%MASTER_PATCH_NDX.EQ.PATCH(1) .AND. INTERFACE_NDX(KK)%SLAVE_PATCH_NDX(1).EQ.PATCH(2) .AND. &
					INTERFACE_NDX(KK)%LC_NDX(3).EQ.INDX(LOCAL_INDX(2))%A .AND. INTERFACE_NDX(KK)%LC_NDX(4).EQ.INDX(LOCAL_INDX(2))%B) THEN
				GLOBAL_INDX(2) = INTERFACE_NDX(KK)%GL_NDX
				GOTO 20
			ELSE
				GLOBAL_INDX(2) = 0
			ENDIF
		ENDDO
		20 CONTINUE
	ENDIF

	DO KK=1, UBOUND(INTERFACE_NDX,1)
		IF (INTERFACE_NDX(KK)%MASTER_PATCH_NDX.EQ.PATCH(1) .AND. INTERFACE_NDX(KK)%SLAVE_PATCH_NDX(3).EQ.PATCH(2) .AND. &
				INTERFACE_NDX(KK)%LC_NDX(7).EQ.INDX(LOCAL_INDX(1))%A .AND. INTERFACE_NDX(KK)%LC_NDX(8).EQ.INDX(LOCAL_INDX(1))%B) THEN
			GLOBAL_INDX(3) = INTERFACE_NDX(KK)%GL_NDX
			GOTO 30
		ELSE
			GLOBAL_INDX(3) = 0
		ENDIF
	ENDDO
	30 CONTINUE

	IF (GLOBAL_INDX(3).EQ.0) THEN
		GLOBAL_INDX(4) = 0
	ELSE
		DO KK=1, UBOUND(INTERFACE_NDX,1)
			IF (INTERFACE_NDX(KK)%SLAVE_PATCH_NDX(1).EQ.PATCH(2) .AND. &
					INTERFACE_NDX(KK)%LC_NDX(3).EQ.INDX(LOCAL_INDX(2))%A .AND. INTERFACE_NDX(KK)%LC_NDX(4).EQ.INDX(LOCAL_INDX(2))%B) THEN
				GLOBAL_INDX(4) = INTERFACE_NDX(KK)%GL_NDX
				GOTO 40
			ELSE
			GLOBAL_INDX(4) = 0
			ENDIF
		ENDDO
	ENDIF
	40 CONTINUE
		
END SUBROUTINE STIF_FIND_GLOBAL_INDX_ALONG_INTERFACE_FIJ

SUBROUTINE STIF_FIND_GLOBAL_INDX_INTERFACE_AND_NONINTERFACE(GLOBAL_INDX, PATCH, LOCAL_INDX, INDX)
	INTEGER, INTENT(OUT) :: GLOBAL_INDX(6)
	INTEGER, INTENT(IN) :: PATCH(2), LOCAL_INDX(2)	! PATCH(1) = MASTER_PATCH, PATCH(2) = SLAVE_PATCH
	TYPE(INT2D), INTENT(IN) :: INDX((BASIS_KVEC(PATCH(2),1)%POLY_ORDER+1)*(BASIS_KVEC(PATCH(2),2)%POLY_ORDER+1))
	
	INTEGER :: I, J, K, II, JJ, KK, LOCAL_DOF_SUM
	
	GLOBAL_INDX(:) = 0
	
	IF (PATCH(2).EQ.1) THEN
		LOCAL_DOF_SUM = 0
	ELSE
		LOCAL_DOF_SUM = SUM(LOCAL_DOF(1:PATCH(2)-1))
	ENDIF
	
	DO KK=1, UBOUND(INTERFACE_NDX,1)
		IF (INTERFACE_NDX(KK)%MASTER_PATCH_NDX.EQ.PATCH(1) .AND. INTERFACE_NDX(KK)%SLAVE_PATCH_NDX(1).EQ.PATCH(2) .AND. &
				INTERFACE_NDX(KK)%LC_NDX(3).EQ.INDX(LOCAL_INDX(1))%A .AND. INTERFACE_NDX(KK)%LC_NDX(4).EQ.INDX(LOCAL_INDX(1))%B) THEN
			GLOBAL_INDX(1) = INTERFACE_NDX(KK)%GL_NDX
			GOTO 555
		ELSE
			GLOBAL_INDX(1) = 0
		ENDIF
	ENDDO
	555 CONTINUE
		
	IF (GLOBAL_INDX(1).EQ.0) THEN
		GLOBAL_INDX(2) = 0
	ELSE
		DO KK = LOCAL_DOF_SUM + 1, LOCAL_DOF_SUM + LOCAL_DOF(PATCH(2))
			IF (NDX(1,KK).EQ.INDX(LOCAL_INDX(2))%A .AND. NDX(2,KK).EQ.INDX(LOCAL_INDX(2))%B) THEN
				GLOBAL_INDX(2) = KK
				GOTO 666
			ELSE
			GLOBAL_INDX(2) = 0
			ENDIF
		ENDDO
		666 CONTINUE
	ENDIF
	
	DO KK=1, UBOUND(INTERFACE_NDX,1)
		IF (INTERFACE_NDX(KK)%MASTER_PATCH_NDX.EQ.PATCH(1) .AND. INTERFACE_NDX(KK)%SLAVE_PATCH_NDX(2).EQ.PATCH(2) .AND. &
				INTERFACE_NDX(KK)%LC_NDX(5).EQ.INDX(LOCAL_INDX(1))%A .AND. INTERFACE_NDX(KK)%LC_NDX(6).EQ.INDX(LOCAL_INDX(1))%B) THEN
			GLOBAL_INDX(3) = INTERFACE_NDX(KK)%GL_NDX
			GOTO 5559
		ELSE
			GLOBAL_INDX(3) = 0
		ENDIF
	ENDDO
	5559 CONTINUE
	
	IF (GLOBAL_INDX(3).EQ.0) THEN
		GLOBAL_INDX(4) = 0
	ELSE
		DO KK = LOCAL_DOF_SUM + 1, LOCAL_DOF_SUM + LOCAL_DOF(PATCH(2))
			IF (NDX(1,KK).EQ.INDX(LOCAL_INDX(2))%A .AND. NDX(2,KK).EQ.INDX(LOCAL_INDX(2))%B) THEN
				GLOBAL_INDX(4) = KK
				GOTO 6789
			ELSE
			GLOBAL_INDX(4) = 0
			ENDIF
		ENDDO
		6789 CONTINUE
	ENDIF
	
	DO KK=1, UBOUND(INTERFACE_NDX,1)
		IF (INTERFACE_NDX(KK)%MASTER_PATCH_NDX.EQ.PATCH(1) .AND. INTERFACE_NDX(KK)%SLAVE_PATCH_NDX(3).EQ.PATCH(2) .AND. &
				INTERFACE_NDX(KK)%LC_NDX(7).EQ.INDX(LOCAL_INDX(1))%A .AND. INTERFACE_NDX(KK)%LC_NDX(8).EQ.INDX(LOCAL_INDX(1))%B) THEN
			GLOBAL_INDX(5) = INTERFACE_NDX(KK)%GL_NDX
			GOTO 579
		ELSE
			GLOBAL_INDX(5) = 0
		ENDIF
	ENDDO
	579 CONTINUE
	
	IF (GLOBAL_INDX(5).EQ.0) THEN
		GLOBAL_INDX(6) = 0
	ELSE
		DO KK = LOCAL_DOF_SUM + 1, LOCAL_DOF_SUM + LOCAL_DOF(PATCH(2))
			IF (NDX(1,KK).EQ.INDX(LOCAL_INDX(2))%A .AND. NDX(2,KK).EQ.INDX(LOCAL_INDX(2))%B) THEN
				GLOBAL_INDX(6) = KK
				GOTO 6669
			ELSE
			GLOBAL_INDX(6) = 0
			ENDIF
		ENDDO
		6669 CONTINUE
	ENDIF
	
END SUBROUTINE STIF_FIND_GLOBAL_INDX_INTERFACE_AND_NONINTERFACE

SUBROUTINE STIF_FIND_GLOBAL_INDX_INTERFACE_AND_EGM(GLOBAL_INDX, PATCHES, LOCAL_INDX, INDX1, INDX2)
	INTEGER, INTENT(IN) :: PATCHES(2), LOCAL_INDX(2) ! PATCHES(1) = IGA_PATCH(SLAVE_PATCH), PATCHES(2) = EGM_PATCH
	TYPE(INT2D), INTENT(IN) :: INDX1((BASIS_KVEC(PATCHES(1),1)%POLY_ORDER+1)*(BASIS_KVEC(PATCHES(1),2)%POLY_ORDER+1))
	TYPE(INT2D), INTENT(IN) :: INDX2((BASIS_KVEC(PATCHES(2),1)%POLY_ORDER+1)*(BASIS_KVEC(PATCHES(2),2)%POLY_ORDER+1))
	INTEGER, INTENT(OUT) :: GLOBAL_INDX(2)
	
	INTEGER :: I, J, K, II, JJ, KK, LOCAL_DOF_SUM
	
	GLOBAL_INDX(:) = 0
	
	IF (PATCHES(2).EQ.1) THEN
		LOCAL_DOF_SUM = 0
	ELSE
		LOCAL_DOF_SUM = SUM(LOCAL_DOF(1:PATCHES(2)-1))
	ENDIF
	
	DO KK=1, UBOUND(INTERFACE_NDX,1)
		IF (INTERFACE_NDX(KK)%SLAVE_PATCH_NDX(1).EQ.PATCHES(1) .AND. &
				INTERFACE_NDX(KK)%LC_NDX(3).EQ.INDX1(LOCAL_INDX(1))%A .AND. INTERFACE_NDX(KK)%LC_NDX(4).EQ.INDX1(LOCAL_INDX(1))%B) THEN
			GLOBAL_INDX(1) = INTERFACE_NDX(KK)%GL_NDX
			GOTO 20
		ELSE
			GLOBAL_INDX(1) = 0
		ENDIF
	ENDDO
	20 CONTINUE
	
	IF (GLOBAL_INDX(1)==0) THEN
		DO KK=1, UBOUND(INTERFACE_NDX,1)
			IF (INTERFACE_NDX(KK)%SLAVE_PATCH_NDX(2).EQ.PATCHES(1) .AND. &
					INTERFACE_NDX(KK)%LC_NDX(5).EQ.INDX1(LOCAL_INDX(1))%A .AND. INTERFACE_NDX(KK)%LC_NDX(6).EQ.INDX1(LOCAL_INDX(1))%B) THEN
				GLOBAL_INDX(1) = INTERFACE_NDX(KK)%GL_NDX
				GOTO 21
			ELSE
				GLOBAL_INDX(1) = 0
			ENDIF
		ENDDO
	21 CONTINUE
	ENDIF
	
	IF (GLOBAL_INDX(1)==0) THEN
		DO KK=1, UBOUND(INTERFACE_NDX,1)
			IF (INTERFACE_NDX(KK)%SLAVE_PATCH_NDX(3).EQ.PATCHES(1) .AND. &
					INTERFACE_NDX(KK)%LC_NDX(7).EQ.INDX1(LOCAL_INDX(1))%A .AND. INTERFACE_NDX(KK)%LC_NDX(8).EQ.INDX1(LOCAL_INDX(1))%B) THEN
				GLOBAL_INDX(1) = INTERFACE_NDX(KK)%GL_NDX
				GOTO 22
			ELSE
				GLOBAL_INDX(1) = 0
			ENDIF
		ENDDO
	22 CONTINUE
	ENDIF
	
	DO KK=1, LOCAL_DOF(PATCHES(2))
		IF (NDX(1,LOCAL_DOF_SUM + KK).EQ.INDX2(LOCAL_INDX(2))%A .AND. NDX(2,LOCAL_DOF_SUM + KK).EQ.INDX2(LOCAL_INDX(2))%B) THEN
			GLOBAL_INDX(2) = LOCAL_DOF_SUM + KK
			GOTO 10
		ELSE
			GLOBAL_INDX(2) = 0
		ENDIF
	ENDDO
	10 CONTINUE
	
END SUBROUTINE STIF_FIND_GLOBAL_INDX_INTERFACE_AND_EGM

SUBROUTINE STIF_GET_ELEMENT(STIF_K, GLOBAL_INDX, DIFF_XX, DIFF_YY, DIFF_XY, DIFF_YX, SYM)
	REAL*8, INTENT(INOUT) :: STIF_K(2*DOF,2*DOF)
	INTEGER, INTENT(IN) :: GLOBAL_INDX(6)
	REAL*8, INTENT(IN) :: DIFF_XX, DIFF_YY, DIFF_XY, DIFF_YX
	CHARACTER(LEN=3), OPTIONAL, INTENT(IN) :: SYM
	
	IF (PRESENT(SYM)) THEN
		IF (GLOBAL_INDX(1).NE.0 .AND. GLOBAL_INDX(2).NE.0) THEN
			STIF_K(		 GLOBAL_INDX(1),		GLOBAL_INDX(2)) = STIF_K(		 GLOBAL_INDX(1),		GLOBAL_INDX(2)) + STRESS_E(1,1)*DIFF_XX + STRESS_E(3,3)*DIFF_YY
			STIF_K(DOF+GLOBAL_INDX(1),DOF+GLOBAL_INDX(2)) = STIF_K(DOF+GLOBAL_INDX(1),DOF+GLOBAL_INDX(2)) + STRESS_E(2,2)*DIFF_YY + STRESS_E(3,3)*DIFF_XX
			STIF_K(		 GLOBAL_INDX(1),DOF+GLOBAL_INDX(2)) = STIF_K(		 GLOBAL_INDX(1),DOF+GLOBAL_INDX(2)) + STRESS_E(1,2)*DIFF_XY + STRESS_E(3,3)*DIFF_YX
! 			STIF_K(DOF+GLOBAL_INDX(2),GLOBAL_INDX(1)) = STIF_K(DOF+GLOBAL_INDX(2),GLOBAL_INDX(1)) + STRESS_E(2,1)*DIFF_XY + STRESS_E(3,3)*DIFF_YX
			
			IF (GLOBAL_INDX(1).NE.GLOBAL_INDX(2)) THEN
				STIF_K(		 GLOBAL_INDX(2),		GLOBAL_INDX(1)) = STIF_K(		 GLOBAL_INDX(2),		GLOBAL_INDX(1)) + STRESS_E(1,1)*DIFF_XX + STRESS_E(3,3)*DIFF_YY
				STIF_K(DOF+GLOBAL_INDX(2),DOF+GLOBAL_INDX(1)) = STIF_K(DOF+GLOBAL_INDX(2),DOF+GLOBAL_INDX(1)) + STRESS_E(2,2)*DIFF_YY + STRESS_E(3,3)*DIFF_XX
				STIF_K(		 GLOBAL_INDX(2),DOF+GLOBAL_INDX(1)) = STIF_K(		 GLOBAL_INDX(2),DOF+GLOBAL_INDX(1)) + STRESS_E(1,2)*DIFF_YX + STRESS_E(3,3)*DIFF_XY
! 				STIF_K(DOF+GLOBAL_INDX(1),GLOBAL_INDX(2)) = STIF_K(DOF+GLOBAL_INDX(1),GLOBAL_INDX(2)) + STRESS_E(2,1)*DIFF_YX + STRESS_E(3,3)*DIFF_XY
			ENDIF
		ENDIF
		IF (GLOBAL_INDX(3).NE.0 .AND. GLOBAL_INDX(4).NE.0) THEN
			STIF_K(		 GLOBAL_INDX(3),		GLOBAL_INDX(4)) = STIF_K(		 GLOBAL_INDX(3),		GLOBAL_INDX(4)) + STRESS_E(1,1)*DIFF_XX + STRESS_E(3,3)*DIFF_YY
			STIF_K(DOF+GLOBAL_INDX(3),DOF+GLOBAL_INDX(4)) = STIF_K(DOF+GLOBAL_INDX(3),DOF+GLOBAL_INDX(4)) + STRESS_E(2,2)*DIFF_YY + STRESS_E(3,3)*DIFF_XX
			STIF_K(		 GLOBAL_INDX(3),DOF+GLOBAL_INDX(4)) = STIF_K(		 GLOBAL_INDX(3),DOF+GLOBAL_INDX(4)) + STRESS_E(1,2)*DIFF_XY + STRESS_E(3,3)*DIFF_YX
! 			STIF_K(DOF+GLOBAL_INDX(4),GLOBAL_INDX(3)) = STIF_K(DOF+GLOBAL_INDX(4),GLOBAL_INDX(3)) + STRESS_E(2,1)*DIFF_XY + STRESS_E(3,3)*DIFF_YX
			
			IF (GLOBAL_INDX(3).NE.GLOBAL_INDX(4)) THEN
				STIF_K(		 GLOBAL_INDX(4),		GLOBAL_INDX(3)) = STIF_K(		 GLOBAL_INDX(4),		GLOBAL_INDX(3)) + STRESS_E(1,1)*DIFF_XX + STRESS_E(3,3)*DIFF_YY
				STIF_K(DOF+GLOBAL_INDX(4),DOF+GLOBAL_INDX(3)) = STIF_K(DOF+GLOBAL_INDX(4),DOF+GLOBAL_INDX(3)) + STRESS_E(2,2)*DIFF_YY + STRESS_E(3,3)*DIFF_XX
				STIF_K(		 GLOBAL_INDX(4),DOF+GLOBAL_INDX(3)) = STIF_K(		 GLOBAL_INDX(4),DOF+GLOBAL_INDX(3)) + STRESS_E(1,2)*DIFF_YX + STRESS_E(3,3)*DIFF_XY
! 				STIF_K(DOF+GLOBAL_INDX(3),GLOBAL_INDX(4)) = STIF_K(DOF+GLOBAL_INDX(3),GLOBAL_INDX(4)) + STRESS_E(2,1)*DIFF_YX + STRESS_E(3,3)*DIFF_XY
			ENDIF
		ENDIF
		IF (GLOBAL_INDX(5).NE.0 .AND. GLOBAL_INDX(6).NE.0) THEN
			STIF_K(		 GLOBAL_INDX(5),		GLOBAL_INDX(6)) = STIF_K(		 GLOBAL_INDX(5),		GLOBAL_INDX(6)) + STRESS_E(1,1)*DIFF_XX + STRESS_E(3,3)*DIFF_YY
			STIF_K(DOF+GLOBAL_INDX(5),DOF+GLOBAL_INDX(6)) = STIF_K(DOF+GLOBAL_INDX(5),DOF+GLOBAL_INDX(6)) + STRESS_E(2,2)*DIFF_YY + STRESS_E(3,3)*DIFF_XX
			STIF_K(		 GLOBAL_INDX(5),DOF+GLOBAL_INDX(6)) = STIF_K(		 GLOBAL_INDX(5),DOF+GLOBAL_INDX(6)) + STRESS_E(1,2)*DIFF_XY + STRESS_E(3,3)*DIFF_YX
! 			STIF_K(DOF+GLOBAL_INDX(6),GLOBAL_INDX(5)) = STIF_K(DOF+GLOBAL_INDX(6),GLOBAL_INDX(5)) + STRESS_E(2,1)*DIFF_XY + STRESS_E(3,3)*DIFF_YX

			IF (GLOBAL_INDX(5).NE.GLOBAL_INDX(6)) THEN
				STIF_K(		 GLOBAL_INDX(6),		GLOBAL_INDX(5)) = STIF_K(		 GLOBAL_INDX(6),		GLOBAL_INDX(5)) + STRESS_E(1,1)*DIFF_XX + STRESS_E(3,3)*DIFF_YY
				STIF_K(DOF+GLOBAL_INDX(6),DOF+GLOBAL_INDX(5)) = STIF_K(DOF+GLOBAL_INDX(6),DOF+GLOBAL_INDX(5)) + STRESS_E(2,2)*DIFF_YY + STRESS_E(3,3)*DIFF_XX
				STIF_K(		 GLOBAL_INDX(6),DOF+GLOBAL_INDX(5)) = STIF_K(		 GLOBAL_INDX(6),DOF+GLOBAL_INDX(5)) + STRESS_E(1,2)*DIFF_YX + STRESS_E(3,3)*DIFF_XY
! 				STIF_K(DOF+GLOBAL_INDX(5),GLOBAL_INDX(6)) = STIF_K(DOF+GLOBAL_INDX(5),GLOBAL_INDX(6)) + STRESS_E(2,1)*DIFF_YX + STRESS_E(3,3)*DIFF_XY
			ENDIF
		ENDIF
	ELSE
		IF (GLOBAL_INDX(1).NE.0 .AND. GLOBAL_INDX(2).NE.0) THEN
			STIF_K(		 GLOBAL_INDX(1),		GLOBAL_INDX(2)) = STIF_K(		 GLOBAL_INDX(1),		GLOBAL_INDX(2)) + STRESS_E(1,1)*DIFF_XX + STRESS_E(3,3)*DIFF_YY
			STIF_K(DOF+GLOBAL_INDX(1),DOF+GLOBAL_INDX(2)) = STIF_K(DOF+GLOBAL_INDX(1),DOF+GLOBAL_INDX(2)) + STRESS_E(2,2)*DIFF_YY + STRESS_E(3,3)*DIFF_XX
			STIF_K(		 GLOBAL_INDX(1),DOF+GLOBAL_INDX(2)) = STIF_K(		 GLOBAL_INDX(1),DOF+GLOBAL_INDX(2)) + STRESS_E(1,2)*DIFF_XY + STRESS_E(3,3)*DIFF_YX
! 			STIF_K(DOF+GLOBAL_INDX(2),GLOBAL_INDX(1)) = STIF_K(DOF+GLOBAL_INDX(2),GLOBAL_INDX(1)) + STRESS_E(2,1)*DIFF_XY + STRESS_E(3,3)*DIFF_YX
		ENDIF
		IF (GLOBAL_INDX(3).NE.0 .AND. GLOBAL_INDX(4).NE.0) THEN
			STIF_K(		 GLOBAL_INDX(3),		GLOBAL_INDX(4)) = STIF_K(		 GLOBAL_INDX(3),		GLOBAL_INDX(4)) + STRESS_E(1,1)*DIFF_XX + STRESS_E(3,3)*DIFF_YY
			STIF_K(DOF+GLOBAL_INDX(3),DOF+GLOBAL_INDX(4)) = STIF_K(DOF+GLOBAL_INDX(3),DOF+GLOBAL_INDX(4)) + STRESS_E(2,2)*DIFF_YY + STRESS_E(3,3)*DIFF_XX
			STIF_K(		 GLOBAL_INDX(3),DOF+GLOBAL_INDX(4)) = STIF_K(		 GLOBAL_INDX(3),DOF+GLOBAL_INDX(4)) + STRESS_E(1,2)*DIFF_XY + STRESS_E(3,3)*DIFF_YX
! 			STIF_K(DOF+GLOBAL_INDX(4),GLOBAL_INDX(3)) = STIF_K(DOF+GLOBAL_INDX(4),GLOBAL_INDX(3)) + STRESS_E(2,1)*DIFF_XY + STRESS_E(3,3)*DIFF_YX
		ENDIF
		IF (GLOBAL_INDX(5).NE.0 .AND. GLOBAL_INDX(6).NE.0) THEN
			STIF_K(		 GLOBAL_INDX(5),		GLOBAL_INDX(6)) = STIF_K(		 GLOBAL_INDX(5),		GLOBAL_INDX(6)) + STRESS_E(1,1)*DIFF_XX + STRESS_E(3,3)*DIFF_YY
			STIF_K(DOF+GLOBAL_INDX(5),DOF+GLOBAL_INDX(6)) = STIF_K(DOF+GLOBAL_INDX(5),DOF+GLOBAL_INDX(6)) + STRESS_E(2,2)*DIFF_YY + STRESS_E(3,3)*DIFF_XX
			STIF_K(		 GLOBAL_INDX(5),DOF+GLOBAL_INDX(6)) = STIF_K(		 GLOBAL_INDX(5),DOF+GLOBAL_INDX(6)) + STRESS_E(1,2)*DIFF_XY + STRESS_E(3,3)*DIFF_YX
! 			STIF_K(DOF+GLOBAL_INDX(6),GLOBAL_INDX(5)) = STIF_K(DOF+GLOBAL_INDX(6),GLOBAL_INDX(5)) + STRESS_E(2,1)*DIFF_XY + STRESS_E(3,3)*DIFF_YX
		ENDIF
	ENDIF
	
END SUBROUTINE STIF_GET_ELEMENT

SUBROUTINE LOAD_VC_GET_ELEMENT(STIF_F, GLOBAL_INDX, DIFF_NN, UV)
	REAL*8, INTENT(INOUT) :: STIF_F(2*DOF)
	INTEGER, INTENT(IN) :: GLOBAL_INDX(6)
	REAL*8, INTENT(IN) :: DIFF_NN
	CHARACTER(LEN=1), INTENT(IN) :: UV
	
	IF (UV=='U') THEN
		IF (GLOBAL_INDX(1).NE.0) THEN
			STIF_F(GLOBAL_INDX(1)) = STIF_F(GLOBAL_INDX(1)) + DIFF_NN
		ENDIF
		IF (GLOBAL_INDX(3).NE.0) THEN
			STIF_F(GLOBAL_INDX(3)) = STIF_F(GLOBAL_INDX(3)) + DIFF_NN
		ENDIF
		IF (GLOBAL_INDX(5).NE.0) THEN
			STIF_F(GLOBAL_INDX(5)) = STIF_F(GLOBAL_INDX(5)) + DIFF_NN
		ENDIF
	ELSEIF (UV=='V') THEN
		IF (GLOBAL_INDX(1).NE.0) THEN
			STIF_F(DOF + GLOBAL_INDX(1)) = STIF_F(DOF + GLOBAL_INDX(1)) + DIFF_NN
		ENDIF
		IF (GLOBAL_INDX(3).NE.0) THEN
			STIF_F(DOF + GLOBAL_INDX(3)) = STIF_F(DOF + GLOBAL_INDX(3)) + DIFF_NN
		ENDIF
		IF (GLOBAL_INDX(5).NE.0) THEN
			STIF_F(DOF + GLOBAL_INDX(5)) = STIF_F(DOF + GLOBAL_INDX(5)) + DIFF_NN
		ENDIF
	ENDIF

END SUBROUTINE LOAD_VC_GET_ELEMENT
	
SUBROUTINE LEAST_SQUARE_LC_INT_II(SF, INDX, WEIGHT, EXACT_ON_BD, PATCH, SUB_LN, GAMMA_HAT)
	INTEGER, INTENT(IN) :: PATCH
	TYPE(VEC2D), INTENT(IN) :: SUB_LN
	CHARACTER(LEN=1), INTENT(IN) :: GAMMA_HAT
	
	REAL*8, INTENT(INOUT) :: WEIGHT(:)
	TYPE(POINT2D), INTENT(INOUT) :: EXACT_ON_BD(UBOUND(WEIGHT,1))
	TYPE(FVALUE), INTENT(INOUT) :: SF(UBOUND(WEIGHT,1), (BASIS_KVEC(PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(PATCH,2)%POLY_ORDER+1))
	TYPE(INT2D), INTENT(INOUT) :: INDX((BASIS_KVEC(PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(PATCH,2)%POLY_ORDER+1))
	
	
	TYPE(POINT2D) :: GSPT, DMY_GSPT, PHYPT_F, INV_PHYPT_G
	REAL*8 :: DET_M
	INTEGER :: I, J, II, JJ, KK
	TYPE(MATRIX_22) :: JACOB
	
	SF(:,:) = FVALUE(0.D0,0.D0,0.D0,0.D0,0.D0,0.D0)
	INDX(:) = INT2D(-1,-1)
	WEIGHT(:) = 0.D0
	
	IF (GAMMA_HAT=='B' .OR. GAMMA_HAT=='T') THEN
		CALL GAULEG(SUB_LN%U%X, SUB_LN%V%X, GSX, GSXW, UBOUND(WEIGHT,1))
	ELSE
		CALL GAULEG(SUB_LN%U%Y, SUB_LN%V%Y, GSY, GSYW, UBOUND(WEIGHT,1))
	ENDIF
	
	DO I=1,UBOUND(WEIGHT,1)
		IF (GAMMA_HAT=='B') THEN
			GSPT = POINT2D(GSX(I), 0.D0)
		ELSEIF (GAMMA_HAT=='T') THEN
			GSPT = POINT2D(GSX(I), 1.D0)
		ELSEIF (GAMMA_HAT=='L') THEN
			GSPT = POINT2D(0.D0, GSY(I))
		ELSEIF (GAMMA_HAT=='R') THEN
			GSPT = POINT2D(1.D0, GSY(I))
		ENDIF
		
		DMY_GSPT = GSPT
		
		JACOB = GET_JACOBIAN_MATRIX(DMY_GSPT,PATCH)
! 		DET_M = .DETERMINANT.JACOB
		DET_M = GET_DET_DR(DMY_GSPT, PATCH, GAMMA_HAT)

		IF (GAMMA_HAT=='B' .OR. GAMMA_HAT=='T') THEN
			WEIGHT(I) = DET_M*GSXW(I)
		ELSEIF (GAMMA_HAT=='L' .OR. GAMMA_HAT=='R') THEN
			WEIGHT(I) = DET_M*GSYW(I)
		ENDIF
		
		IF (PATCH.LE.NUM_IGA_PATCH) THEN
			CALL GET_ALL_PHY_NURBS_SURFACE_2D(SF(I,:), INDX(:), DMY_GSPT, JACOB, PATCH)
		ELSE
			CALL GET_ALL_PHY_BASIS_IN_INT(SF(I,:), INDX(:), DMY_GSPT, JACOB, PATCH)
		ENDIF
		EXACT_ON_BD(I) = EX_DISP(DMY_GSPT, PATCH)
	ENDDO

END SUBROUTINE LEAST_SQUARE_LC_INT_II

SUBROUTINE LN_INT_BY_MAM(SN_SF, SN_INDX, SN_WEIGHT, EXACT_ON_BD, PATCH, SUB_LN, SN_FACTOR, GAMMA_HAT)
	INTEGER, INTENT(IN) :: PATCH, SN_FACTOR
	TYPE(VEC2D), INTENT(IN) :: SUB_LN
	CHARACTER(LEN=1), INTENT(IN) :: GAMMA_HAT
	
	REAL*8, INTENT(INOUT) :: SN_WEIGHT(:)
	TYPE(POINT2D), INTENT(INOUT) :: EXACT_ON_BD(UBOUND(SN_WEIGHT,1))
	TYPE(FVALUE), INTENT(INOUT) :: SN_SF(UBOUND(SN_WEIGHT,1), (BASIS_KVEC(PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(PATCH,2)%POLY_ORDER+1))
	TYPE(INT2D), INTENT(INOUT) :: SN_INDX((BASIS_KVEC(PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(PATCH,2)%POLY_ORDER+1))
	
	
	TYPE(POINT2D) :: GSPT, DMY_GSPT, PHYPT_F, INV_PHYPT_G
	REAL*8 :: DET_M
	INTEGER :: I, J, II, JJ, KK
	TYPE(MATRIX_22) :: JACOB
	
	SN_SF(:,:) = FVALUE(0.D0,0.D0,0.D0,0.D0,0.D0,0.D0)
	SN_INDX(:) = INT2D(-1,-1)
	SN_WEIGHT(:) = 0.D0
	EXACT_ON_BD(:) = POINT2D(0.D0,0.D0)
	
	IF (GAMMA_HAT=='B' .OR. GAMMA_HAT=='T') THEN
		CALL GAULEG(SUB_LN%U%X**(1.D0/(1.D0*SN_FACTOR)), SUB_LN%V%X**(1.D0/(1.D0*SN_FACTOR)), GSX, GSXW, UBOUND(SN_WEIGHT,1))
	ELSE
		CALL GAULEG(SUB_LN%U%Y**(1.D0/(1.D0*SN_FACTOR)), SUB_LN%V%Y**(1.D0/(1.D0*SN_FACTOR)), GSY, GSYW, UBOUND(SN_WEIGHT,1))
	ENDIF
	
	DO I=1,UBOUND(SN_WEIGHT,1)
		IF (GAMMA_HAT=='B') THEN
			GSPT = POINT2D(GSX(I)**SN_FACTOR, 0.D0)
		ELSEIF (GAMMA_HAT=='T') THEN
			GSPT = POINT2D(GSX(I)**SN_FACTOR, 1.D0)
		ELSEIF (GAMMA_HAT=='L') THEN
			GSPT = POINT2D(0.D0, GSY(I)**SN_FACTOR)
		ELSEIF (GAMMA_HAT=='R') THEN
			GSPT = POINT2D(1.D0, GSY(I)**SN_FACTOR)
		ENDIF
		
		DMY_GSPT = GSPT
		
		JACOB = GET_JACOBIAN_MATRIX(DMY_GSPT,PATCH)
! 		DET_M = .DETERMINANT.JACOB
		DET_M = GET_DET_SN(DMY_GSPT, PATCH, SN_FACTOR, GAMMA_HAT)

		IF (GAMMA_HAT=='B' .OR. GAMMA_HAT=='T') THEN
			SN_WEIGHT(I) = DET_M*GSXW(I)
		ELSEIF (GAMMA_HAT=='L' .OR. GAMMA_HAT=='R') THEN
			SN_WEIGHT(I) = DET_M*GSYW(I)
		ENDIF
		
		IF (PATCH.LE.NUM_IGA_PATCH) THEN
			CALL GET_ALL_PHY_NURBS_SURFACE_2D(SN_SF(I,:), SN_INDX(:), DMY_GSPT, JACOB, PATCH)
		ELSE
			CALL GET_ALL_PHY_BASIS_IN_INT(SN_SF(I,:), SN_INDX(:), DMY_GSPT, JACOB, PATCH)
		ENDIF
		EXACT_ON_BD(I) = EX_DISP(DMY_GSPT, PATCH)
	ENDDO

END SUBROUTINE LN_INT_BY_MAM

SUBROUTINE LEAST_SQUARE_LC_INT_IJ(SF1, SF2, INDX1, INDX2, WEIGHT, PATCHES, SUB_LN, SUPP_IGA, GAMMA_HAT)
	
	INTEGER, INTENT(IN) :: PATCHES(2) ! PATCHES(1) = IGA_PATCH,  PATCHES(2) = EGM_PATCH
	TYPE(VEC2D), INTENT(IN) :: SUB_LN, SUPP_IGA
	CHARACTER(LEN=1), INTENT(IN) :: GAMMA_HAT
	
	REAL*8, INTENT(INOUT) :: WEIGHT(:)
	
	TYPE(FVALUE), INTENT(INOUT) :: SF1(UBOUND(WEIGHT,1), (BASIS_KVEC(PATCHES(1),1)%POLY_ORDER+1)*(BASIS_KVEC(PATCHES(1),2)%POLY_ORDER+1))
	TYPE(FVALUE), INTENT(INOUT) :: SF2(UBOUND(WEIGHT,1), (BASIS_KVEC(PATCHES(2),1)%POLY_ORDER+1)*(BASIS_KVEC(PATCHES(2),2)%POLY_ORDER+1))
	TYPE(INT2D), INTENT(INOUT) :: INDX1((BASIS_KVEC(PATCHES(1),1)%POLY_ORDER+1)*(BASIS_KVEC(PATCHES(1),2)%POLY_ORDER+1))
	TYPE(INT2D), INTENT(INOUT) :: INDX2((BASIS_KVEC(PATCHES(2),1)%POLY_ORDER+1)*(BASIS_KVEC(PATCHES(2),2)%POLY_ORDER+1))
	
	TYPE(POINT2D) :: GSPT, DMY_GSPT, PHYPT_F, INV_PHYPT_G
	REAL*8 :: DET_M
	INTEGER :: I, J, II, JJ, KK
	TYPE(MATRIX_22) :: JACOB
	LOGICAL :: CHECK_PT_LINE
	
	SF1(:,:) = FVALUE(0.D0,0.D0,0.D0,0.D0,0.D0,0.D0)
	SF2(:,:) = FVALUE(0.D0,0.D0,0.D0,0.D0,0.D0,0.D0)
	INDX1(:) = INT2D(-1,-1)
	INDX2(:) = INT2D(-1,-1)
	WEIGHT(:) = 0.D0
	
	IF (GAMMA_HAT=='B' .OR. GAMMA_HAT=='T') THEN
		CALL GAULEG(SUB_LN%U%X, SUB_LN%V%X, XIGA_GSX, XIGA_GSXW, UBOUND(WEIGHT,1))
	ELSE
		CALL GAULEG(SUB_LN%U%Y, SUB_LN%V%Y, XIGA_GSY, XIGA_GSYW, UBOUND(WEIGHT,1))
	ENDIF
	
	DO I=1,UBOUND(WEIGHT,1)
		IF (GAMMA_HAT=='B') THEN
			GSPT = POINT2D(XIGA_GSX(I), 0.D0)
		ELSEIF (GAMMA_HAT=='T') THEN
			GSPT = POINT2D(XIGA_GSX(I), 1.D0)
		ELSEIF (GAMMA_HAT=='L') THEN
			GSPT = POINT2D(0.D0, XIGA_GSY(I))
		ELSEIF (GAMMA_HAT=='R') THEN
			GSPT = POINT2D(1.D0, XIGA_GSY(I))
		ENDIF
		
		DMY_GSPT = GSPT
		PHYPT_F = GET_PHY_PT(DMY_GSPT, PATCHES(2))
		INV_PHYPT_G = GET_REF_PT(PHYPT_F, PATCHES(1))
		
		CHECK_PT_LINE = PTLIEON(INV_PHYPT_G, SUPP_IGA)
! 		print*, patches, gamma_hat, check_pt_line
		IF (CHECK_PT_LINE.EQV..TRUE.) THEN
			JACOB = GET_JACOBIAN_MATRIX(DMY_GSPT,PATCHES(2))
! 			DET_M = .DETERMINANT.JACOB
			DET_M = GET_DET_DR(DMY_GSPT, PATCHES(2), GAMMA_HAT)
			
			IF (GAMMA_HAT=='B' .OR. GAMMA_HAT=='T') THEN
				WEIGHT(I) = DET_M*XIGA_GSXW(I)
			ELSEIF (GAMMA_HAT=='L' .OR. GAMMA_HAT=='R') THEN
				WEIGHT(I) = DET_M*XIGA_GSYW(I)
			ENDIF
			
			CALL GET_ALL_PHY_NURBS_SURFACE_2D(SF1(I,:), INDX1(:), INV_PHYPT_G, JACOB, PATCHES(1))
			CALL GET_ALL_PHY_BASIS_IN_INT(SF2(I,:), INDX2(:), DMY_GSPT, JACOB, PATCHES(2))
		ENDIF
	ENDDO

END SUBROUTINE LEAST_SQUARE_LC_INT_IJ

SUBROUTINE DR_GL_INDX_FII(GLOBAL_INDX, PATCH, LOCAL_INDX, INDX)
	INTEGER, INTENT(IN) :: PATCH, LOCAL_INDX(2)
	TYPE(INT2D), INTENT(IN) :: INDX((BASIS_KVEC(PATCH,1)%POLY_ORDER+1)*(BASIS_KVEC(PATCH,2)%POLY_ORDER+1))
	INTEGER, INTENT(OUT) :: GLOBAL_INDX(2)
	
	INTEGER :: I, J, K, II, JJ, KK, LC_NUM_SUM
	
	GLOBAL_INDX(:) = 0
	
	IF (PATCH.EQ.1) THEN
		LC_NUM_SUM = 0
	ELSE
		LC_NUM_SUM = SUM(DR_BDNDX(1:PATCH-1,1)%LC_NUM)
	ENDIF

	DO KK=1, DR_BDNDX(PATCH,1)%LC_NUM
! 				PRINT*, 'KK',KK
		IF (DR_BDNDX(PATCH,KK)%LC_NDX(1).EQ.INDX(LOCAL_INDX(1))%A .AND. DR_BDNDX(PATCH,KK)%LC_NDX(2).EQ.INDX(LOCAL_INDX(1))%B) THEN
			GLOBAL_INDX(1) = LC_NUM_SUM + KK
! 							PRINT*, PATCH, 'G1', GLOBAL_INDX(1)
			GOTO 111
		ELSE
			GLOBAL_INDX(1) = 0
		ENDIF
	ENDDO
	111 CONTINUE

	DO KK=1, DR_BDNDX(PATCH,1)%LC_NUM
! 					PRINT*, 'KK',KK
		IF (DR_BDNDX(PATCH,KK)%LC_NDX(1).EQ.INDX(LOCAL_INDX(2))%A .AND. DR_BDNDX(PATCH,KK)%LC_NDX(2).EQ.INDX(LOCAL_INDX(2))%B) THEN
			GLOBAL_INDX(2) = LC_NUM_SUM + KK
! 								PRINT*, PATCH, 'G2', GLOBAL_INDX(2)
			GOTO 222
		ELSE
			GLOBAL_INDX(2) = 0
		ENDIF
	ENDDO
	222 CONTINUE

END SUBROUTINE DR_GL_INDX_FII

SUBROUTINE DR_GL_INDX_FIJ(GLOBAL_INDX, PATCHES, LOCAL_INDX, INDX1, INDX2)
	INTEGER, INTENT(IN) :: PATCHES(2), LOCAL_INDX(2)
	TYPE(INT2D), INTENT(IN) :: INDX1((BASIS_KVEC(PATCHES(1),1)%POLY_ORDER+1)*(BASIS_KVEC(PATCHES(1),2)%POLY_ORDER+1))
	TYPE(INT2D), INTENT(IN) :: INDX2((BASIS_KVEC(PATCHES(2),1)%POLY_ORDER+1)*(BASIS_KVEC(PATCHES(2),2)%POLY_ORDER+1))
	INTEGER, INTENT(OUT) :: GLOBAL_INDX(2)
	
	INTEGER :: I, J, K, II, JJ, KK, LC_NUM_SUM(2)
	
	GLOBAL_INDX(:) = 0
	
	DO I = 1, 2
		IF (PATCHES(I).EQ.1) THEN
			LC_NUM_SUM(I) = 0
		ELSE
			LC_NUM_SUM(I) = SUM(DR_BDNDX(1:PATCHES(I)-1,1)%LC_NUM)
		ENDIF
	ENDDO

	DO KK=1, DR_BDNDX(PATCHES(1),1)%LC_NUM
! 				PRINT*, 'KK',KK
		IF (DR_BDNDX(PATCHES(1),KK)%LC_NDX(1).EQ.INDX1(LOCAL_INDX(1))%A .AND. DR_BDNDX(PATCHES(1),KK)%LC_NDX(2).EQ.INDX1(LOCAL_INDX(1))%B) THEN
			GLOBAL_INDX(1) = LC_NUM_SUM(1) + KK
! 							PRINT*, PATCH, 'G1', GLOBAL_INDX(1)
			GOTO 111
		ELSE
			GLOBAL_INDX(1) = 0
		ENDIF
	ENDDO
	111 CONTINUE

	DO KK=1, DR_BDNDX(PATCHES(2),1)%LC_NUM
! 					PRINT*, 'KK',KK
		IF (DR_BDNDX(PATCHES(2),KK)%LC_NDX(1).EQ.INDX2(LOCAL_INDX(2))%A .AND. DR_BDNDX(PATCHES(2),KK)%LC_NDX(2).EQ.INDX2(LOCAL_INDX(2))%B) THEN
			GLOBAL_INDX(2) = LC_NUM_SUM(2) + KK
! 								PRINT*, PATCH, 'G2', GLOBAL_INDX(2)
			GOTO 222
		ELSE
			GLOBAL_INDX(2) = 0
		ENDIF
	ENDDO
	222 CONTINUE

END SUBROUTINE DR_GL_INDX_FIJ

SUBROUTINE DR_FIND_GL_INDX_ALONG_INTERFACE_FII(GLOBAL_INDX, PATCH, LOCAL_INDX, INDX)
	INTEGER, INTENT(OUT) :: GLOBAL_INDX(6)
	INTEGER, INTENT(IN) :: PATCH(2), LOCAL_INDX(2)	! PATCH(1) = MASTER_PATCH, PATCH(2) = SLAVE_PATCH
	TYPE(INT2D), INTENT(IN) :: INDX((BASIS_KVEC(PATCH(2),1)%POLY_ORDER+1)*(BASIS_KVEC(PATCH(2),2)%POLY_ORDER+1))
	
	INTEGER :: I, J, K, II, JJ, KK, GL_INDX_TO_SLAVE_PATCH_NDX(6)
	
	GLOBAL_INDX(:) = 0
	GL_INDX_TO_SLAVE_PATCH_NDX = (/1, 1, 2, 2, 3, 3/)
	
	DO I = 1, UBOUND(GLOBAL_INDX,1)
		IF (MOD(I,2)==0) THEN
			DO KK=1, UBOUND(INTERFACE_BDNDX,1)
				IF (INTERFACE_BDNDX(KK)%MASTER_PATCH_NDX.EQ.PATCH(1) .AND. INTERFACE_BDNDX(KK)%SLAVE_PATCH_NDX(GL_INDX_TO_SLAVE_PATCH_NDX(I)).EQ.PATCH(2) .AND. &
						INTERFACE_BDNDX(KK)%LC_NDX(I+1).EQ.INDX(LOCAL_INDX(2))%A .AND. INTERFACE_BDNDX(KK)%LC_NDX(I+2).EQ.INDX(LOCAL_INDX(2))%B) THEN
					GLOBAL_INDX(I) = INTERFACE_BDNDX(KK)%GL_BDNDX
					GOTO 112
				ELSE
					GLOBAL_INDX(I) = 0
				ENDIF
			ENDDO
		ELSE
			DO KK=1, UBOUND(INTERFACE_BDNDX,1)
				IF (INTERFACE_BDNDX(KK)%MASTER_PATCH_NDX.EQ.PATCH(1) .AND. INTERFACE_BDNDX(KK)%SLAVE_PATCH_NDX(GL_INDX_TO_SLAVE_PATCH_NDX(I)).EQ.PATCH(2) .AND. &
						INTERFACE_BDNDX(KK)%LC_NDX(I+2).EQ.INDX(LOCAL_INDX(1))%A .AND. INTERFACE_BDNDX(KK)%LC_NDX(I+3).EQ.INDX(LOCAL_INDX(1))%B) THEN
					GLOBAL_INDX(I) = INTERFACE_BDNDX(KK)%GL_BDNDX
					GOTO 223
				ELSE
					GLOBAL_INDX(I) = 0
				ENDIF
			ENDDO
		ENDIF
		112 CONTINUE
		223 CONTINUE
	ENDDO
	
END SUBROUTINE DR_FIND_GL_INDX_ALONG_INTERFACE_FII

SUBROUTINE DR_FIND_GL_INDX_ALONG_INTERFACE_FIJ(GLOBAL_INDX, PATCH, LOCAL_INDX, INDX)
	INTEGER, INTENT(OUT) :: GLOBAL_INDX(2)
	INTEGER, INTENT(IN) :: PATCH(2), LOCAL_INDX(2)	! PATCH(1) = MASTER_PATCH, PATCH(2) = SLAVE_PATCH
	TYPE(INT2D), INTENT(IN) :: INDX((BASIS_KVEC(PATCH(2),1)%POLY_ORDER+1)*(BASIS_KVEC(PATCH(2),2)%POLY_ORDER+1))
	INTEGER :: I, J, K, II, JJ, KK, LC_NUM_SUM

	GLOBAL_INDX(:) = 0
	
	IF (PATCH(2).EQ.1) THEN
		LC_NUM_SUM = 0
	ELSE
		LC_NUM_SUM = SUM(DR_BDNDX(1:PATCH(2)-1,1)%LC_NUM)
	ENDIF
	
	DO I = 1, 3
		DO KK=1, UBOUND(INTERFACE_BDNDX,1)
			IF (INTERFACE_BDNDX(KK)%MASTER_PATCH_NDX.EQ.PATCH(1) .AND. INTERFACE_BDNDX(KK)%SLAVE_PATCH_NDX(I).EQ.PATCH(2) .AND. &
					INTERFACE_BDNDX(KK)%LC_NDX(2*I+1).EQ.INDX(LOCAL_INDX(1))%A .AND. INTERFACE_BDNDX(KK)%LC_NDX(2*(I+1)).EQ.INDX(LOCAL_INDX(1))%B) THEN
				GLOBAL_INDX(1) = INTERFACE_BDNDX(KK)%GL_BDNDX
				GOTO 223
			ELSE
				GLOBAL_INDX(1) = 0
			ENDIF
		ENDDO
	ENDDO
	223 CONTINUE

	DO KK=1, DR_BDNDX(PATCH(2),1)%LC_NUM
		IF (DR_BDNDX(PATCH(2),KK)%LC_NDX(1).EQ.INDX(LOCAL_INDX(2))%A .AND. DR_BDNDX(PATCH(2),KK)%LC_NDX(2).EQ.INDX(LOCAL_INDX(2))%B) THEN
			GLOBAL_INDX(2) = LC_NUM_SUM + KK
			GOTO 225
		ELSE
			GLOBAL_INDX(2) = 0
		ENDIF
	ENDDO
	225 CONTINUE
	
END SUBROUTINE DR_FIND_GL_INDX_ALONG_INTERFACE_FIJ

SUBROUTINE DR_FIND_GL_INDX_ALONG_INTERFACE_AND_NONINTERFACE(GLOBAL_INDX, PATCH, LOCAL_INDX, INDX)
	INTEGER, INTENT(OUT) :: GLOBAL_INDX(2)
	INTEGER, INTENT(IN) :: PATCH(2), LOCAL_INDX(2)	! PATCH(1) = MASTER_PATCH, PATCH(2) = SLAVE_PATCH
	TYPE(INT2D), INTENT(IN) :: INDX((BASIS_KVEC(PATCH(2),1)%POLY_ORDER+1)*(BASIS_KVEC(PATCH(2),2)%POLY_ORDER+1))
	INTEGER :: I, J, K, II, JJ, KK, LC_NUM_SUM

	GLOBAL_INDX(:) = 0
	
	IF (PATCH(2).EQ.1) THEN
		LC_NUM_SUM = 0
	ELSE
		LC_NUM_SUM = SUM(DR_BDNDX(1:PATCH(2)-1,1)%LC_NUM)
	ENDIF
	
	DO KK=1, UBOUND(INTERFACE_BDNDX,1)
		IF (INTERFACE_BDNDX(KK)%MASTER_PATCH_NDX.EQ.PATCH(1) .AND. INTERFACE_BDNDX(KK)%SLAVE_PATCH_NDX(1).EQ.PATCH(2) .AND. &
				INTERFACE_BDNDX(KK)%LC_NDX(3).EQ.INDX(LOCAL_INDX(1))%A .AND. INTERFACE_BDNDX(KK)%LC_NDX(4).EQ.INDX(LOCAL_INDX(1))%B) THEN
			GLOBAL_INDX(1) = INTERFACE_BDNDX(KK)%GL_BDNDX
			GOTO 1
		ELSE
			GLOBAL_INDX(1) = 0
		ENDIF
	ENDDO
	1 CONTINUE

	IF (GLOBAL_INDX(1)==0) THEN
		DO KK=1, UBOUND(INTERFACE_BDNDX,1)
			IF (INTERFACE_BDNDX(KK)%MASTER_PATCH_NDX.EQ.PATCH(1) .AND. INTERFACE_BDNDX(KK)%SLAVE_PATCH_NDX(2).EQ.PATCH(2) .AND. &
					INTERFACE_BDNDX(KK)%LC_NDX(5).EQ.INDX(LOCAL_INDX(1))%A .AND. INTERFACE_BDNDX(KK)%LC_NDX(6).EQ.INDX(LOCAL_INDX(1))%B) THEN
				GLOBAL_INDX(1) = INTERFACE_BDNDX(KK)%GL_BDNDX
				GOTO 3
			ELSE
				GLOBAL_INDX(1) = 0
			ENDIF
		ENDDO
		3 CONTINUE
	ENDIF
	
	IF (GLOBAL_INDX(1)==0) THEN
		DO KK=1, UBOUND(INTERFACE_BDNDX,1)
			IF (INTERFACE_BDNDX(KK)%MASTER_PATCH_NDX.EQ.PATCH(1) .AND. INTERFACE_BDNDX(KK)%SLAVE_PATCH_NDX(3).EQ.PATCH(2) .AND. &
					INTERFACE_BDNDX(KK)%LC_NDX(7).EQ.INDX(LOCAL_INDX(1))%A .AND. INTERFACE_BDNDX(KK)%LC_NDX(8).EQ.INDX(LOCAL_INDX(1))%B) THEN
				GLOBAL_INDX(1) = INTERFACE_BDNDX(KK)%GL_BDNDX
				GOTO 4
			ELSE
				GLOBAL_INDX(1) = 0
			ENDIF
		ENDDO
		4 CONTINUE
	ENDIF
	
	DO KK=1, DR_BDNDX(PATCH(2),1)%LC_NUM
		IF (DR_BDNDX(PATCH(2),KK)%LC_NDX(1).EQ.INDX(LOCAL_INDX(2))%A .AND. DR_BDNDX(PATCH(2),KK)%LC_NDX(2).EQ.INDX(LOCAL_INDX(2))%B) THEN
			GLOBAL_INDX(2) = LC_NUM_SUM + KK
			GOTO 2
		ELSE
			GLOBAL_INDX(2) = 0
		ENDIF
	ENDDO
	2 CONTINUE
		
END SUBROUTINE DR_FIND_GL_INDX_ALONG_INTERFACE_AND_NONINTERFACE

SUBROUTINE DR_FIND_GL_INDX_ALONG_INTERFACE_AND_EGM(GLOBAL_INDX, PATCH, LOCAL_INDX, INDX1, INDX2)
	INTEGER, INTENT(OUT) :: GLOBAL_INDX(2)
	INTEGER, INTENT(IN) :: PATCH(2), LOCAL_INDX(2)	! PATCH(1) = IGA_PATCH(SLAVE_PATCH), PATCH(2) = EGM_PATCH
	TYPE(INT2D), INTENT(IN) :: INDX1((BASIS_KVEC(PATCH(1),1)%POLY_ORDER+1)*(BASIS_KVEC(PATCH(1),2)%POLY_ORDER+1))
	TYPE(INT2D), INTENT(IN) :: INDX2((BASIS_KVEC(PATCH(2),1)%POLY_ORDER+1)*(BASIS_KVEC(PATCH(2),2)%POLY_ORDER+1))
	INTEGER :: I, J, K, II, JJ, KK, LC_NUM_SUM

	GLOBAL_INDX(:) = 0
	
	IF (PATCH(2).EQ.1) THEN
		LC_NUM_SUM = 0
	ELSE
		LC_NUM_SUM = SUM(DR_BDNDX(1:PATCH(2)-1,1)%LC_NUM)
	ENDIF
	
	DO KK=1, UBOUND(INTERFACE_BDNDX,1)
		IF (INTERFACE_BDNDX(KK)%SLAVE_PATCH_NDX(1).EQ.PATCH(1) .AND. &
				INTERFACE_BDNDX(KK)%LC_NDX(3).EQ.INDX1(LOCAL_INDX(1))%A .AND. INTERFACE_BDNDX(KK)%LC_NDX(4).EQ.INDX1(LOCAL_INDX(1))%B) THEN
			GLOBAL_INDX(1) = INTERFACE_BDNDX(KK)%GL_BDNDX
			GOTO 1
		ELSE
			GLOBAL_INDX(1) = 0
		ENDIF
	ENDDO
	1 CONTINUE

	IF (GLOBAL_INDX(1)==0) THEN
		DO KK=1, UBOUND(INTERFACE_BDNDX,1)
			IF (INTERFACE_BDNDX(KK)%SLAVE_PATCH_NDX(2).EQ.PATCH(1) .AND. &
					INTERFACE_BDNDX(KK)%LC_NDX(5).EQ.INDX1(LOCAL_INDX(1))%A .AND. INTERFACE_BDNDX(KK)%LC_NDX(6).EQ.INDX1(LOCAL_INDX(1))%B) THEN
				GLOBAL_INDX(1) = INTERFACE_BDNDX(KK)%GL_BDNDX
				GOTO 3
			ELSE
				GLOBAL_INDX(1) = 0
			ENDIF
		ENDDO
		3 CONTINUE
	ENDIF
	
	IF (GLOBAL_INDX(1)==0) THEN
		DO KK=1, UBOUND(INTERFACE_BDNDX,1)
			IF (INTERFACE_BDNDX(KK)%SLAVE_PATCH_NDX(3).EQ.PATCH(1) .AND. &
					INTERFACE_BDNDX(KK)%LC_NDX(7).EQ.INDX1(LOCAL_INDX(1))%A .AND. INTERFACE_BDNDX(KK)%LC_NDX(8).EQ.INDX1(LOCAL_INDX(1))%B) THEN
				GLOBAL_INDX(1) = INTERFACE_BDNDX(KK)%GL_BDNDX
				GOTO 4
			ELSE
				GLOBAL_INDX(1) = 0
			ENDIF
		ENDDO
		4 CONTINUE
	ENDIF
	
	DO KK=1, DR_BDNDX(PATCH(2),1)%LC_NUM
		IF (DR_BDNDX(PATCH(2),KK)%LC_NDX(1).EQ.INDX2(LOCAL_INDX(2))%A .AND. DR_BDNDX(PATCH(2),KK)%LC_NDX(2).EQ.INDX2(LOCAL_INDX(2))%B) THEN
			GLOBAL_INDX(2) = LC_NUM_SUM + KK
			GOTO 2
		ELSE
			GLOBAL_INDX(2) = 0
		ENDIF
	ENDDO
	2 CONTINUE
		
END SUBROUTINE DR_FIND_GL_INDX_ALONG_INTERFACE_AND_EGM


END MODULE INTEGRATION